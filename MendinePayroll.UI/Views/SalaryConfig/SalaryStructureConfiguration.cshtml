@{
    ViewBag.Title = "Salary Configuration";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

<style>
    /* --- SCOPED STYLES --- */
    :root {
        --primary: #0E7777;
        --primary-dark: #095555;
        --text-dark: #2c3e50;
        --text-light: #636e72;
        --border: #dfe6e9;
        --white: #ffffff;
        --bg: #f4f7f6;
    }

    /* --- 1. PAGE HEADER --- */
    .page-header-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: var(--white);
        padding: 15px 25px;
        border-radius: 8px;
        border: 1px solid var(--border);
        box-shadow: 0 2px 5px rgba(0,0,0,0.02);
        margin-bottom: 20px;
        height: 60px;
    }

    .page-title {
        font-size: 20px;
        font-weight: 700;
        color: var(--primary);
        margin: 0;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .btn-add {
        background: var(--primary);
        color: white;
        border: none;
        padding: 0 20px;
        height: 38px;
        border-radius: 6px;
        font-weight: 600;
        font-size: 14px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.2s;
        text-decoration: none;
    }

        .btn-add:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: 0 4px 10px rgba(14,119,119,0.2);
            color: white;
        }

    /* --- 2. MAIN GRID --- */
    .grid-card {
        background: var(--white);
        border-radius: 8px;
        border: 1px solid var(--border);
        overflow: hidden;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }

    .main-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
    }

        .main-table th {
            background: #f8f9fa;
            text-align: left;
            padding: 15px 20px;
            font-weight: 600;
            color: var(--text-light);
            border-bottom: 2px solid var(--border);
            text-transform: uppercase;
            font-size: 11px;
            letter-spacing: 0.5px;
        }

        .main-table td {
            padding: 12px 20px;
            border-bottom: 1px solid #f1f1f1;
            vertical-align: middle;
            color: #333;
        }

        .main-table tr:hover {
            background-color: #faffff;
        }

    /* --- 3. MODAL STYLES --- */
    .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 9999;
        backdrop-filter: blur(3px);
    }

    .modal-box {
        background: var(--white);
        width: 95%;
        max-width: 1300px;
        margin: 30px auto;
        border-radius: 12px;
        box-shadow: 0 20px 60px rgba(0,0,0,0.25);
        display: flex;
        flex-direction: column;
        max-height: 90vh;
        animation: slideUp 0.3s ease;
    }

    @@keyframes slideUp {
        from {
            transform: translateY(30px);
            opacity: 0;
        }

        to {
            transform: translateY(0);
            opacity: 1;
        }
    }

    .modal-header {
        padding: 25px 25px;
        background: var(--primary-light);
        border-bottom: 1px solid var(--border);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .modal-title {
        font-size: 18px;
        font-weight: 700;
        color: var(--primary);
        margin: 0;
    }

    .btn-close {
        background: none;
        border: none;
        font-size: 20px;
        cursor: pointer;
        color: #666;
    }

    .modal-body {
        padding: 25px;
        overflow-y: auto;
        flex: 1;
        background: #f9fbfb;
    }

    .modal-footer {
        padding: 15px 25px;
        background: #fff;
        border-top: 1px solid var(--border);
        display: flex;
        justify-content: flex-end;
        gap: 10px;
    }

    /* --- 4. FORM ELEMENTS (Inside Modal) --- */
    .form-row {
        display: flex;
        gap: 20px;
        margin-bottom: 15px;
    }

    .form-group {
        flex: 1;
    }

    .form-label {
        display: block;
        font-size: 12px;
        font-weight: 700;
        color: var(--text-dark);
        margin-bottom: 6px;
        text-transform: uppercase;
    }

    .form-control {
        width: 100%;
        padding: 8px 10px;
        border: 1px solid #cbd5e0;
        border-radius: 4px;
        font-size: 13px;
        box-sizing: border-box;
        height: 38px;
    }

        .form-control:focus {
            border-color: var(--primary);
            outline: none;
            background: #faffff;
        }

    /* --- 5. CONFIGURATION PANELS --- */
    .panel {
        border: 1px solid var(--border);
        border-radius: 6px;
        margin-bottom: 25px;
        overflow: hidden;
        background: white;
        box-shadow: 0 2px 5px rgba(0,0,0,0.02);
    }

    .panel-head {
        background: #f8f9fa;
        padding: 10px 15px;
        font-weight: 700;
        color: var(--text-dark);
        font-size: 13px;
        border-bottom: 1px solid var(--border);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .panel-body {
        padding: 15px;
    }

    .checkbox-grid {
        display: flex;
        column-gap: 10px;
        align-items: center;
    }

    .chk-item {
        display: flex;
        align-items: flex-start;
        gap: 6px;
        font-size: 13px;
        cursor: pointer;
        font-weight: 500;
    }

        .chk-item input {
            accent-color: var(--primary);
            transform: scale(1.2);
        }

    /* --- 6. INNER TABLES (Earnings/Deductions) --- */
    .config-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
    }

        .config-table th {
            background: #eee;
            padding: 10px;
            text-align: left;
            font-weight: 700;
            color: #555;
            border-bottom: 2px solid #ddd;
            border-right: 1px solid #ddd;
        }

        .config-table td {
            padding: 8px;
            border-bottom: 1px solid #eee;
            border-right: 1px solid #f0f0f0;
            vertical-align: middle;
        }

    .tbl-input {
        width: 100%;
        padding: 6px;
        border: 1px solid #ccc;
        border-radius: 3px;
        font-size: 12px;
    }

    .tbl-select {
        width: 100%;
        padding: 6px;
        border: 1px solid #ccc;
        border-radius: 3px;
        font-size: 12px;
        background: #fff;
        height: 100%;
    }

    .disabled-input {
        background: #f0f0f0;
        color: #999;
        cursor: not-allowed;
        border-color: #ddd;
        pointer-events: none;
    }

    .badge {
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 10px;
        font-weight: 700;
        text-transform: uppercase;
    }

    .badge-blue {
        background: #e3f2fd;
        color: #0984e3;
        border: 1px solid #bbdefb;
    }

    .badge-purple {
        background: #f3e5f5;
        color: #8e44ad;
        border: 1px solid #e1bee7;
    }

    .badge-var {
        background: #fff3cd;
        color: #856404;
        padding: 2px 5px;
        border-radius: 3px;
        margin-left: 5px;
        border: 1px solid #ffeeba;
        display: none;
    }

    .select-var {
        background-color: #fff8e1;
        border-color: #ffeeba;
        color: #d35400;
        font-weight: bold;
    }

    .action-btn {
        background: none;
        border: none;
        cursor: pointer;
        font-size: 14px;
        color: #95a5a6;
        padding: 6px;
        transition: 0.2s;
        border-radius: 4px;
    }

        .action-btn:hover {
            color: var(--primary);
            background: #e0f2f2;
        }

    .btn-cancel {
        background: white;
        border: 1px solid #ccc;
        color: #555;
        padding: 8px 20px;
        border-radius: 6px;
        font-weight: 600;
        cursor: pointer;
    }

    .btn-save {
        background: var(--primary);
        color: white;
        border: none;
        padding: 8px 24px;
        border-radius: 6px;
        font-weight: 600;
        cursor: pointer;
    }

    /* ============================================================
    COMPONENT BADGES (Shown beside component names)
    ============================================================ */

    /* COMPONENT BADGES (Pill Rounded) */
    .badge-sm {
        display: inline-block;
        padding: 3px 6px;
        font-size: 9px;
        font-weight: 400;
        border-radius: 10px; /* <-- Rounded pill */
        margin-left: 2px;
        text-transform: uppercase;
        vertical-align: middle;
        letter-spacing: 0.3px;
        line-height:12px;
    }

    /* Manual / Calculative / Statutory / Gross / Basic / Variable / Loan */
    .bg-blue { /* CALCULATIVE */
        background: #e3f2fd;
        color: #1565c0;
        border: 1px solid #90caf9;
    }

    .bg-orange { /* MANUAL */
        background: #fff4e5;
        color: #ef6c00;
        border: 1px solid #ffcc80;
    }

    .bg-red { /* STATUTORY */
        background: #ffebee;
        color: #c62828;
        border: 1px solid #ef9a9a;
    }

    .bg-green { /* GROSS */
        background: #e8f5e9;
        color: #2e7d32;
        border: 1px solid #a5d6a7;
    }

    .bg-purple { /* BASIC */
        background: #f3e5f5;
        color: #6a1b9a;
        border: 1px solid #ce93d8;
    }

    .bg-yellow { /* VARIABLE */
        background: #fffde7;
        color: #f9a825;
        border: 1px solid #fff59d;
    }

    .bg-gray { /* LOAN */
        background: #eceff1;
        color: #455a64;
        border: 1px solid #cfd8dc;
    }



    /* ============================================================
    PANEL HEADER BADGES (Shown in the header like todepower UI)
    ============================================================ */
    .panel-head-badge {
        display: inline-block;
        padding: 3px 8px;
        font-size: 10px;
        font-weight: 600;
        border-radius: 4px;
        margin-left: 10px;
        text-transform: uppercase;
        vertical-align: middle;
    }

    /* Header Badge Colors */
    .bg-h-manual { /* System Inputs */
        background: #fff4e5;
        color: #d35400;
        border: 1px solid #ffcc80;
    }

    .bg-h-earn { /* Earnings & Allowances */
        background: #e3f2fd;
        color: #1565c0;
        border: 1px solid #90caf9;
    }

    .bg-h-ded { /* Deductions */
        background: #ffebee;
        color: #b71c1c;
        border: 1px solid #ef9a9a;
    }

    .bg-h-ctc { /* Company Contributions */
        background: #f3e5f5;
        color: #6a1b9a;
        border: 1px solid #ce93d8;
    }

    .tbl-input inp-formula {
        text-transform: uppercase;
    }

    #txtStructure {
        text-transform: uppercase;
    }

    /* Force DataTable inside your white card layout */
    #tblSalaryConfig_wrapper {
        padding: 20px;
    }

    /* Search box spacing */
    .dataTables_filter label {
        font-weight: 600;
        color: #2c3e50;
    }

    .dataTables_filter input {
        margin-left: 6px !important;
        padding: 6px 10px;
        border: 1px solid #ccc !important;
        border-radius: 6px;
    }

    /* Page length dropdown */
    .dataTables_length select {
        padding: 4px 8px;
        border-radius: 6px;
        border: 1px solid #ccc !important;
    }

    /* Fix table header height */
    table.dataTable thead th {
        padding-top: 12px !important;
        padding-bottom: 12px !important;
        font-size: 12px;
        background: #f8f9fa !important;
    }

    /* Row hover */
    table.dataTable tbody tr:hover {
        background-color: #faffff !important;
    }

    /* Pagination style improve */
    .dataTables_paginate .paginate_button {
        padding: 4px 10px !important;
        border-radius: 6px !important;
        margin: 2px !important;
        border: 1px solid #ddd !important;
    }

        .dataTables_paginate .paginate_button.current {
            background: #0E7777 !important;
            color: #fff !important;
            border-color: #0E7777 !important;
        }
</style>

<section role="main" class="content-body">
    <header class="page-header">
        <h2>Salary Configuration</h2>
    </header>
    <div class="page-header-row">
        <h1 class="page-title">
            <i class="fas fa-calculator"></i> Salary Configuration
        </h1>
        <button class="btn-add" onclick="openModal()">
            <i class="fas fa-plus"></i>Add New
        </button>
    </div>

    <section class="panel">
        <div class="panel-body">
            <table id="tblSalaryConfig" class="main-table display nowrap" style="width:100%">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Structure Name</th>
                        <th>Type</th>
                        <th>Pay Group</th>
                        <th>Components</th>
                        <th style="text-align:right">Action</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>

        </div>
    </section>

    <div id="configModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">Configure Salary Structure</h3>
                <button class="btn-close" onclick="closeModal()">&times;</button>
            </div>

            <div class="modal-body">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Structure Name <span style="color:red">*</span></label>
                        <input type="text" id="txtStructure" onkeyup="this.value = this.value.toUpperCase();" class="form-control" placeholder="e.g. Factory Structure 2025">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Type <span style="color:red">*</span></label>
                        <select class="form-control">
                            <option value="1">Normal (Monthly)</option>
                            <option value="2">Contractual (Hourly/Daily)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Pay Group<span style="color:red">*</span></label>
                        <select id="ddlPayGroup" class="form-control"></select>
                    </div>
                </div>
                <input type="hidden" id="hdnMode" value="ADD" />
                <input type="hidden" id="hdnEditID" value="0" />

                <div class="panel">
                    <div class="panel-head">System Inputs (Manual)</div>
                    <div class="panel-body">
                        <div class="checkbox-grid" id="manualContainer"></div>
                    </div>
                </div>

                <div class="panel">
                    <div class="panel-head">Earnings & Allowances</div>
                    <table class="config-table">
                        <thead>
                            <tr>
                                <th style="width:30px; text-align:center;"> </th>
                                <th style="width:200px;">Component</th>
                                <th style="width:120px;">Time Basis</th>
                                <th style="width:150px;">Calc Logic</th>
                                <th style="width:200px;">Formula / Source</th>
                                <th style="width:40px; text-align:center;">%</th>
                                <th style="width:100px;">Rate / Value</th>
                            </tr>
                        </thead>
                        <tbody id="tbody_earnings"></tbody>
                    </table>
                </div>

                <div class="panel">
                    <div class="panel-head" style="border-top: 3px solid #e74c3c;">Deductions</div>
                    <table class="config-table">
                        <thead>
                            <tr>
                                <th style="width:30px; text-align:center;"> </th>
                                <th style="width:200px;">Component</th>
                                <th style="width:120px;">Time Basis</th>
                                <th style="width:150px;">Calc Logic</th>
                                <th style="width:200px;">Formula / Source</th>
                                <th style="width:40px; text-align:center;">%</th>
                                <th style="width:100px;">Rate / Value</th>
                            </tr>
                        </thead>
                        <tbody id="tbody_deductions"></tbody>
                    </table>
                </div>

                <div class="panel">
                    <div class="panel-head" style="border-top: 3px solid #f39c12;">Company Contributions (CTC)</div>
                    <table class="config-table">
                        <thead>
                            <tr>
                                <th style="width:30px; text-align:center;"> </th>
                                <th style="width:200px;">Component</th>
                                <th style="width:120px;">Time Basis</th>
                                <th style="width:150px;">Calc Logic</th>
                                <th style="width:200px;">Formula / Source</th>
                                <th style="width:40px; text-align:center;">%</th>
                                <th style="width:100px;">Rate / Value</th>
                            </tr>
                        </thead>
                        <tbody id="tbody_contributions"></tbody>
                    </table>
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeModal()">Cancel</button>
                <button class="btn-save" id="btnSaveConfig" onclick="saveData()">Save Configuration</button>
            </div>
        </div>
    </div>
</section>

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- DataTables CSS -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.dataTables.min.css">

<!-- DataTables JS -->
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>

<!-- Toastr -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>

<script>
    $(document).ready(function () {
        loadPayGroupLink();
        loadSalaryStructureTable();
    });
    function loadSalaryStructureTable() {

        // Destroy old table if exists
        if ($.fn.DataTable.isDataTable('#tblSalaryConfig')) {
            $('#tblSalaryConfig').DataTable().destroy();
        }

        $("#tblSalaryConfig").DataTable({
            paging: true,
            searching: true,
            lengthChange: true,
            pageLength: 10,
            ordering: true,
            responsive: true,
            autoWidth: false,

            ajax: {
                url: "/SalaryConfig/GetSalaryConfigList",
                type: "POST",
                datatype: "json",
                dataSrc: ""
            },

            columns: [
                { data: "SalaryConfigureID" },

                {
                    data: "SalaryConfigureName",
                    render: function (data) {
                        return `<strong>${data}</strong>`;
                    }
                },

                {
                    data: "SalaryConfigureType",
                    render: function (type) {
                        if (type == "1")
                            return `<span class="badge badge-blue">Monthly</span>`;
                        else
                            return `<span class="badge badge-purple">Hourly</span>`;
                    }
                },

                { data: "PayGroupName" },

                {
                    data: "TotalComponents",
                    render: d => `${d} Items`
                },

                {
                    data: "SalaryConfigureID",
                    orderable: false,
                    render: function (id) {
                        return `
                            <div style="text-align:right">
                                <button class="action-btn" onclick="editConfig(${id})">
                                    <i class="fas fa-pen"></i>
                                </button>
                                <button class="action-btn" onclick="deleteConfig(${id})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        `;
                    }
                }
            ],

            language: {
                emptyTable: "No Salary Structures found",
                processing: "Loading...",
            }
        });
    }


    function loadPayGroupLink() {
        var $ddl = $("#ddlPayGroup");

        $.ajax({
            type: "GET",
            url: "/ConfigureSalaryComponent/GetPayGroup",
            success: function (data) {
                $ddl.find('option:not(:first)').remove();
                $.each(data, function (i, item) {
                    $ddl.append($('<option>', {
                        value: item.Value,
                        text: item.Text
                    }));
                });
            }
        });
    }

    let masterData = [];

    // ============================================================
    // LOAD PAYCONFIG MASTER
    // ============================================================
    function loadMasterData() {
        return $.ajax({
            type: "POST",
            url: "/SalaryConfig/GetAllPayConfig",
            success: function (res) {
                masterData = res;
            }
        });
    }

    // ============================================================
    // BADGE GENERATOR
    // ============================================================
    function buildBadges(pc) {
        let html = "";
        console.log(pc)
        if (pc.EntryType === "Manual") html += `<span class="badge-sm bg-orange">Manu</span>`;
        if (pc.EntryType === "Calculative") html += `<span class="badge-sm bg-blue">Calc</span>`;
        if (pc.IsStatutory) html += `<span class="badge-sm bg-red">${pc.StatutoryType}</span>`;
        if (pc.IsGrossComponent) html += `<span class="badge-sm bg-green">Gross</span>`;
        if (pc.IsBasicComponent) html += `<span class="badge-sm bg-purple">Bas</span>`;
        if (pc.IsOther) html += `<span class="badge-sm bg-yellow">${pc.OtherType}</span>`;

        return html;
    }

    // ============================================================
    // OPEN / CLOSE MODAL
    // ============================================================
    function openModal() {
        $("#hdnMode").val("ADD");
        $("#hdnEditID").val("0");

        $("#modalTitle").text("Configure Salary Structure [Add]");
        $("#btnSaveConfig").text("Save Configuration");

        loadMasterData().done(() => {
            renderManuals();
            renderGrid("Allowances", "tbody_earnings");
            renderGrid("Deduction", "tbody_deductions");
            renderGrid("CC", "tbody_contributions");
            $("#configModal").fadeIn(200);
        });
    }

    function closeModal() {

        // 1️⃣ Hide modal
        $("#configModal").fadeOut(200);

        // 2️⃣ Clear text inputs
        $("#txtStructure").val("");

        // 3️⃣ Reset dropdowns
        $("#ddlPayGroup").val("0");

        // 4️⃣ Reset hidden fields
        $("#hdnMode").val("ADD");
        $("#hdnEditID").val("0");

        // 5️⃣ Clear manual checkbox grid
        $("#manualContainer").empty();

        // 6️⃣ Clear dynamic tables
        $("#tbody_earnings").empty();
        $("#tbody_deductions").empty();
        $("#tbody_contributions").empty();

        // 7️⃣ Reset modal title
        $("#modalTitle").text("Configure Salary Structure");

        // 8️⃣ Remove any validation CSS classes if used
        $(".form-control").removeClass("is-invalid is-valid");

        // 9️⃣ Reload main table after closing
        loadSalaryStructureTable();
    }


    // ============================================================
    // RENDER MANUAL (System Inputs)
    // ============================================================
    function renderManuals() {
        const container = $("#manualContainer");
        container.empty();

        masterData
            .filter(x => x.PayConfigType === "Manual")
            .forEach(pc => {
                container.append(`
                        <label class="chk-item">
                            <input type="checkbox" value="${pc.PayConfigId}">
                            ${pc.PayConfigName}
                            ${buildBadges(pc)}
                        </label>
                    `);
            });
    }

    // ============================================================
    // RENDER GRID
    // ============================================================
    function renderGrid(type, tbodyId) {
        const tbody = document.getElementById(tbodyId);
        tbody.innerHTML = "";

        masterData.filter(x => x.PayConfigType === type).forEach(pc => {

            let logicDropdown = "";

            // CASE 1: NON CALCULATIVE + VARIABLE AMOUNT (SHOW FULL DROPDOWN)
            if (!pc.IScalculative && pc.IsVariableAmt) {
                logicDropdown = `
                        <select class="tbl-select logic-select" onchange="handleLogicChange(this)" disabled>
                            <option value="FIXED">Fixed</option>
                            <option value="FORMULA">Formula</option>
                            <option value="MONTHLY_UPLOAD">Excel Upload</option>
                            <option value="ATTENDANCE_UNIT">Attendance Unit</option>
                        </select>
                    `;
            }
            // CASE 2: PURE FIXED (Non-calculative only)
            else if (!pc.IScalculative && !pc.IsVariableAmt) {
                logicDropdown = `
                        <select class="tbl-select logic-select" disabled>
                            <option value="FIXED">Fixed</option>
                        </select>
                    `;
            }
            // CASE 3: CALCULATIVE
            else {
                logicDropdown = `
                        <select class="tbl-select logic-select" onchange="handleLogicChange(this)" disabled>
                            <option value="FIXED">Fixed</option>
                            <option value="FORMULA">Formula</option>
                            <option value="EXCEL_UPLOAD">Excel Upload</option>
                            <option value="ATTENDANCE_UNIT">Attendance Unit</option>
                        </select>
                    `;
            }

            let row = `
                    <tr id="row_${pc.PayConfigId}">
                        <td style="text-align:center;">
                            <input type="checkbox" class="comp-check"
                                   onchange="toggleEnable(this)" data-id="${pc.PayConfigId}">
                        </td>

                        <td>
                            <strong>${pc.PayConfigName}</strong>
                            ${buildBadges(pc)}
                        </td>

                        <td>
                            <select class="tbl-select basis-select" disabled>
                                <option value="MONTHLY">Monthly</option>
                                <option value="HOURLY">Hourly</option>
                                <option value="DAILY">Daily</option>
                            </select>
                        </td>

                        <td>${logicDropdown}</td>

                        <td>
                            <input type="text" onkeyup="this.value=this.value.toUpperCase();" class="tbl-input inp-formula" disabled>
                            <select class="tbl-select inp-source" style="display:none;" disabled>
                                <option value="">-- Map Column --</option>
                                <option value="OT_HOURS">OT Hours</option>
                                <option value="TOTAL_HOURS">Total Hours</option>
                                <option value="NIGHT_SHIFT">Night Shift</option>
                            </select>
                        </td>

                        <td style="text-align:center;">
                            <input type="checkbox" class="chk-percent" disabled>
                        </td>

                        <td>
                            <input type="text" class="tbl-input inp-rate" disabled>
                        </td>
                    </tr>
                `;

            tbody.innerHTML += row;
        });
    }

    // ============================================================
    // FIELD ENABLE/DISABLE
    // ============================================================
    window.toggleEnable = function (chk) {

        let row = chk.closest("tr");
        let isChecked = chk.checked;

        let basis = row.querySelector(".basis-select");
        let logic = row.querySelector(".logic-select");
        let formula = row.querySelector(".inp-formula");
        let source = row.querySelector(".inp-source");
        let percent = row.querySelector(".chk-percent");
        let rate = row.querySelector(".inp-rate");

        const pcId = chk.getAttribute("data-id");
        const pc = masterData.find(x => x.PayConfigId == pcId);

        // UNCHECK → disable all
        if (!isChecked) {
            basis.disabled = true;
            logic.disabled = true;
            formula.disabled = true;
            source.disabled = true;
            percent.disabled = true;
            rate.disabled = true;
            return;
        }

        basis.disabled = false;

        // CASE 1: NON CALCULATIVE + VARIABLE → FULL LOGIC
        if (!pc.IScalculative && pc.IsVariableAmt) {
            logic.disabled = false;
            handleLogicChange(logic);
            return;
        }

        // CASE 2: PURE FIXED
        if (!pc.IScalculative && !pc.IsVariableAmt) {
            logic.disabled = true;
            handleLogicChangeFixedOnly(row);
            return;
        }

        // CASE 3: CALCULATIVE
        logic.disabled = false;
        handleLogicChange(logic);
    };

    // Helper for pure fixed
    function handleLogicChangeFixedOnly(row) {
        let formula = row.querySelector(".inp-formula");
        let source = row.querySelector(".inp-source");
        let percent = row.querySelector(".chk-percent");
        let rate = row.querySelector(".inp-rate");

        formula.disabled = true;
        formula.style.display = "block";

        source.disabled = true;
        source.style.display = "none";

        percent.disabled = true;
        percent.checked = false;

        rate.disabled = false; // Only rate enabled
    }

    // ============================================================
    // LOGIC CHANGE
    // ============================================================
    window.handleLogicChange = function (elem) {

        let row = elem.closest("tr");
        let logic = elem.value;

        let formula = row.querySelector(".inp-formula");
        let source = row.querySelector(".inp-source");
        let percent = row.querySelector(".chk-percent");
        let rate = row.querySelector(".inp-rate");

        formula.disabled = true;
        source.disabled = true;
        percent.disabled = true;
        rate.disabled = true;

        formula.style.display = "block";
        source.style.display = "none";

        // 1️⃣ FIXED
        if (logic === "FIXED") {
            rate.disabled = true; // Fixed means no formula - ManualRate enabled later only for pure fixed
            rate.disabled = false;
            return;
        }

        // 2️⃣ FORMULA
        if (logic === "FORMULA") {
            formula.disabled = false;
            percent.disabled = false;
            rate.disabled = false;
            return;
        }

        // 3️⃣ MONTHLY UPLOAD
        if (logic === "MONTHLY_UPLOAD") {
            formula.value = "";
            formula.disabled = true;

            percent.checked = false;
            percent.disabled = true;

            rate.value = "";
            rate.disabled = true;
            return;
        }

        // 4️⃣ ATTENDANCE UNIT
        if (logic === "ATTENDANCE_UNIT") {
            formula.style.display = "none";
            source.style.display = "block";
            source.disabled = false;
            rate.value = "";
            return;
        }
    };

    // ============================================================
    // SAVE
    // ============================================================
    function saveData() {

        let selected = [];
        let mode = $("#hdnMode").val();     // ADD / EDIT
        let editID = $("#hdnEditID").val(); // 0 or actual ID
        // ============================================================
        // 1️⃣ ADD MANUAL COMPONENTS
        // ============================================================
        $("#manualContainer input[type='checkbox']").each(function () {
            if (!this.checked) return;

            let pcId = $(this).val();

            selected.push({
                PayConfigId: pcId,
                PayType: "Manual",
                TimeBasis: "",
                LogicType: "FIXED",
                CalculationFormula: "",
                MappedColumn: "",
                ManualRate: "",
                ISPercentage: 0
            });
        });

        // ============================================================
        // 2️⃣ ADD GRID COMPONENTS
        // ============================================================
        $("#tbody_earnings tr, #tbody_deductions tr, #tbody_contributions tr").each(function () {

            let chk = $(this).find(".comp-check")[0];
            if (!chk.checked) return;

            let pcId = $(chk).data("id");

            let basis = $(this).find(".basis-select").val();
            let logic = $(this).find(".logic-select").val();
            let formula = $(this).find(".inp-formula").val();
            let source = $(this).find(".inp-source").val();
            let percent = $(this).find(".chk-percent").prop("checked") ? 1 : 0;
            let rate = $(this).find(".inp-rate").val();

            let pc = masterData.find(x => x.PayConfigId == pcId);

            selected.push({
                PayConfigId: pcId,
                PayType: pc.PayConfigType,
                TimeBasis: basis,
                LogicType: logic,
                CalculationFormula: logic === "ATTENDANCE_UNIT" ? "" : formula,
                MappedColumn: logic === "ATTENDANCE_UNIT" ? source : "",
                ManualRate: rate,
                ISPercentage: percent
            });
        });

        // ============================================================
        // VALIDATION & PAYLOAD BUILD
        // ============================================================
        let headerDiv = $(".form-row").first();

        let structureName = headerDiv.find(".form-group:nth-child(1) input").val().trim();
        let structureType = headerDiv.find(".form-group:nth-child(2) select").val();
        let payGroupId = headerDiv.find(".form-group:nth-child(3) select").val();

        if (structureName === "") {
            alert("Enter Structure Name");
            return;
        }

        if (payGroupId === "" || payGroupId === "0") {
            alert("Select Pay Group");
            return;
        }

        let payload = {
            SalaryConfigureID: mode === "EDIT" ? editID : 0,
            SalaryConfigureName: structureName,
            SalaryConfigureType: structureType,
            PayGroupID: payGroupId,
            ComponentListJson: JSON.stringify(selected)
        };

        // ============================================================
        // AJAX SAVE CALL
        // ============================================================
        $.ajax({
            type: "POST",
            url: "/SalaryConfig/SaveSalaryConfig",
            data: JSON.stringify(payload),
            contentType: "application/json",
            success: function (res) {
                if (res.Success) {
                    toastr.success("Saved Successfully!");
                    closeModal();
                } else {
                    toastr.error("Error: " + res.Message);
                }
            }
        });
    }

    function editConfig(id) {
        $("#hdnMode").val("EDIT");
        $("#hdnEditID").val(id);

        $("#modalTitle").text("Configure Salary Structure [Edit]");
        $("#btnSaveConfig").text("Update Configuration");

        $.ajax({
            type: "POST",
            url: "/SalaryConfig/GetSalaryConfigById",
            data: { SalaryConfigureID: id },
            success: function (res) {

                if (!res.Success) {
                    console.error("SERVER ERROR → ", res.Message);
                    console.error("STACK → ", res.Stack);
                    alert("Server Error: " + res.Message);
                    return;
                }

                let header = res.Header[0];
                let detail = res.Detail;

                // =====================================================
                // 1️⃣ Load Master Data → Render UI → Then Apply Values
                // =====================================================
                loadMasterData().done(() => {

                    // Clear old UI
                    $("#manualContainer").empty();
                    $("#tbody_earnings").empty();
                    $("#tbody_deductions").empty();
                    $("#tbody_contributions").empty();

                    // Render full UI again with fresh master
                    renderManuals();
                    renderGrid("Allowances", "tbody_earnings");
                    renderGrid("Deduction", "tbody_deductions");
                    renderGrid("CC", "tbody_contributions");

                    // =====================================================
                    // 2️⃣ Fill HEADER fields
                    // =====================================================
                    $(".form-row").first().find(".form-group:nth-child(1) input").val(header.SalaryConfigureName);
                    $(".form-row").first().find(".form-group:nth-child(2) select").val(header.SalaryConfigureType);
                    $(".form-row").first().find(".form-group:nth-child(3) select").val(header.PayGroupID);

                    // Store current ID for update mode
                    window.currentEditID = header.SalaryConfigureID;

                    // =====================================================
                    // 3️⃣ LOOP DETAIL RECORDS → APPLY TO UI
                    // =====================================================
                    detail.forEach(item => {

                        let pcId = item.PayConfigId;

                        // ---------- A. MANUAL COMPONENT ----------
                        if (item.PayType === "Manual") {
                            $("#manualContainer input[value='" + pcId + "']")
                                .prop("checked", true);
                            return;   // next item
                        }

                        // ---------- B. GRID COMPONENT ----------
                        let row = $("#row_" + pcId);

                        if (row.length) {

                            let chk = row.find(".comp-check")[0];

                            // Mark selected
                            chk.checked = true;

                            // Enable all fields for this row (based on config rules)
                            toggleEnable(chk);

                            // Fill values now
                            row.find(".basis-select").val(item.TimeBasis);
                            row.find(".logic-select").val(item.LogicType);

                            // Trigger logic change to show correct UI (formula/source)
                            handleLogicChange(row.find(".logic-select")[0]);

                            // Apply values to fields
                            row.find(".inp-formula").val(item.CalculationFormula);
                            row.find(".inp-source").val(item.MappedColumn);
                            row.find(".inp-rate").val(item.ManualRate);

                            row.find(".chk-percent").prop("checked", item.ISPercentage == 1);
                        }

                    });

                    // =====================================================
                    // 4️⃣ Finally open modal
                    // =====================================================
                    $("#configModal").fadeIn(200);
                });
            },
            error: function (xhr) {
                console.log("GET CONFIG ERROR →", xhr.responseText);
                alert("Server Error While Loading!");
            }
        });
    }



    function deleteConfig(id) {

        if (!confirm("Are you sure you want to delete this Salary Configuration?"))
            return;

        $.ajax({
            type: "POST",
            url: "/SalaryConfig/DeleteSalaryConfig",
            data: { SalaryConfigureID: id },
            success: function (res) {

                if (res.Success) {
                    toastr.success("Salary Configuration deleted successfully!");
                    loadSalaryStructureTable(); // reload main grid
                }
                else {
                    toastr.error("Error: " + res.Message);
                }
            },
            error: function (err) {
                console.error("Delete Error:", err);
                toastr.error("Server error while deleting configuration!");
            }
        });
    }


</script>



