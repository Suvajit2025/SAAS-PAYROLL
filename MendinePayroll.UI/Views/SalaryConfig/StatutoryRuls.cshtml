@{
    ViewBag.Title = "Statutory Rules Setup";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<style>
    body {
        font-family: Arial;
        background: #f6f8fa;
    }

    .container-box {
        background: #fff;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,.08);
    }

    .btn-add {
        background: #0E7777;
        color: #fff;
        padding: 4px 14px;
        border-radius: 4px;
    }

    .btn-edit {
        background: #167d80;
        color: #fff;
        padding: 3px 10px;
        border-radius: 3px;
    }

    .btn-delete {
        background: #cc0000;
        color: #fff;
        padding: 3px 10px;
        border-radius: 3px;
    }

    .section-title {
        font-size: 14px;
        font-weight: bold;
        margin-top: 10px;
        color: #444;
    }

    .hidden {
        display: none;
    }

    .action-icon:hover {
        opacity: 0.7;
        transform: scale(1.1);
        transition: 0.1s ease-in-out;
    }
</style>

<section role="main" class="content-body">

    <header class="page-header">
        <h2>Statutory Rules Setup</h2>
    </header>

    <section class="panel">
        <header class="panel-heading">
            <div style="float:right;">
                <button class="btn-add" onclick="openAddModal()">+ Add Rule</button>
            </div>
            <h2 class="panel-title">Statutory Rules</h2>
        </header>

        <div class="panel-body container-box">

            <!-- ================= GRID ================= -->
            <table class="table table-bordered table-striped" id="rulesGrid">
                <thead>
                    <tr>
                        <th>Component</th>
                        <th>Type</th>
                        <th>MaxLimit/LWF/PTAX</th>
                        <th>Effective Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>

        </div>
    </section>
</section>



<!-- ============================================================ -->
<!-- ================== ADD/EDIT MODAL ========================== -->
<!-- ============================================================ -->

<div id="ruleModal" class="modal fade" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">

            <div class="modal-header" style="background:#0E7777;color:#fff;">
                <h4 class="modal-title" id="modalTitle">Add Rule</h4>
                @*<button type="button" class="close" data-dismiss="modal" style="color:#fff;">&times;</button>*@
            </div>

            <div class="modal-body">

                <input type="hidden" id="StatutoryRuleID" />

                <label>Component</label>
                <select id="modalComponent" class="form-control"></select>

                <label>Effective From</label>
                <input type="date" id="modalEffective" class="form-control" />

                <!-- PF -->
                <div id="modalPfBox" class="hidden">
                    <div class="section-title">PF Rules</div>

                    <label>Max Limit</label>
                    <input id="modalPfMax" class="form-control" type="number" />

                    <label>Rounding</label>
                    <select id="modalPfRound" class="form-control"></select>
                </div>

                <!-- ESIC -->
                <div id="modalEsicBox" class="hidden">
                    <div class="section-title">ESIC Rules</div>

                    <label>Max Limit</label>
                    <input id="modalEsicMax" class="form-control" type="number" />

                    <label>Rounding</label>
                    <select id="modalEsicRound" class="form-control"></select>
                </div>

                <!-- LWF -->
                <div id="modalLwfBox" class="hidden">
                    <div class="section-title">LWF Rules</div>

                    <label>Month</label>
                    <select id="modalLwfMonth" class="form-control">
                        <option value="January">January</option>
                        <option value="June">June</option>
                        <option value="December">December</option>
                    </select>

                    <label>Amount</label>
                    <input id="modalLwfAmt" class="form-control" type="number" />
                </div>

                <!-- PTAX -->
                <div id="modalPtaxBox" class="hidden">
                    <div class="section-title">PTAX Slabs</div>

                    <label>State</label>
                    <select id="modalPtaxState" class="form-control"></select>

                    <button class="btn-add mt-2 mb-2" onclick="addModalPTAXRow()">+ Add Slab</button>

                    <table class="table">
                        <thead>
                            <tr>
                                <th>Min</th>
                                <th>Max</th>
                                <th>PTAX</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="modalPtaxSlabBody"></tbody>
                    </table>
                </div>

            </div>

            <div class="modal-footer">
                <button class="btn btn-default" data-dismiss="modal">Close</button>
                <button class="btn btn-primary" onclick="saveRule()">Save</button>
            </div>

        </div>
    </div>
</div>


<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" rel="stylesheet" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>

<!-- ============================================================ -->
<!-- ===================== JAVASCRIPT =========================== -->
<!-- ============================================================ -->

<script>
    $(function () {
        loadGrid();
        loadModalComponents();
        loadRoundingTypes();
    });


    // ---------------- GRID LOAD -----------------
    function loadGrid() {
        $.post("/SalaryConfig/GetStatutoryRules", function (data) {
            let tbody = $("#rulesGrid tbody");
            tbody.empty();

            data.forEach(row => {
                tbody.append(`
                <tr>
                    <td>${row.PayConfigName}</td>
                    <td>${row.StatutoryType}</td>
                    <td>${row.DisplayValue}</td>
                    <td>${row.EffectiveDate}</td>
                    <td style="text-align:center;">

                        <i class="fa fa-edit text-primary action-icon"
                           data-toggle="tooltip" data-placement="top" title="Edit Rule"
                           style="cursor:pointer; margin-right:10px; font-size:16px;"
                           onclick="openEditModal(${row.StatutoryRuleID})"></i>

                        <i class="fa fa-trash text-danger action-icon"
                           data-toggle="tooltip" data-placement="top" title="Delete Rule"
                           style="cursor:pointer; font-size:16px;"
                           onclick="deleteRule(${row.StatutoryRuleID})"></i>

                    </td>
                </tr>
            `);
                // Activate tooltips for icons
                $('[data-toggle="tooltip"]').tooltip();
            });
        });
    }



    // ---------------- ADD MODAL -----------------
    function openAddModal() {
        $("#modalTitle").text("Add Rule");
        $("#StatutoryRuleID").val("");

        clearModalFields();

        $("#ruleModal").modal("show");
        setTimeout(() => {
            // PF default
            $("#modalPfRound option:first").prop("selected", true);

            // ESIC default
            $("#modalEsicRound option:first").prop("selected", true);
        }, 100);
    }



    // ---------------- EDIT MODAL -----------------
    function openEditModal(id) {
        $("#modalTitle").text("Edit Rule");
        clearModalFields();

        $.post("/SalaryConfig/GetStatutoryRuleById", { statutoryRuleId: id }, function (res) {

            if (!res.success) {
                alert(res.message || "Unable to load rule.");
                return;
            }

            var m = res.data;

            // Hidden ID for save
            $("#StatutoryRuleID").val(m.StatutoryRuleId);

            // Component + show correct section via change handler
            $("#modalComponent")
                .val(m.PayConfigId)
                .trigger("change");

            // Effective date
            $("#modalEffective").val(m.EffectiveDate);   // already in yyyy-MM-dd

            // PF
            if (m.StatutoryType.indexOf("PF") >= 0) {
                $("#modalPfMax").val(m.MaxLimit);
                $("#modalPfRound").val(m.RoundingType);
            }

            // ESIC
            if (m.StatutoryType.indexOf("ESIC") >= 0) {
                $("#modalEsicMax").val(m.MaxLimit);
                $("#modalEsicRound").val(m.RoundingType);
            }

            // LWF
            if (m.StatutoryType === "LWF") {
                $("#modalLwfMonth").val(m.LWFMonth);
                $("#modalLwfAmt").val(m.LWFAmount);
            }

            // PTAX
            if (m.StatutoryType === "PTAX") {
                loadModalStates(function () {
                    $("#modalPtaxState").val(m.StateId).trigger("change");
                });

                // Now fill slabs also after dropdown exists
                fillPTAXSlabs(m.Slabs);

            }

            $("#ruleModal").modal("show");
        });
    }
    function addModalPTAXRow() {
        $("#modalPtaxSlabBody").append(`
        <tr>
            <td><input type="number" class="form-control min" step="0.01" placeholder="Min Salary"></td>
            <td><input type="number" class="form-control max" step="0.01" placeholder="Max Salary"></td>
            <td><input type="number" class="form-control val" step="0.01" placeholder="PTAX Amount"></td>
            <td><button type="button" class="btn-delete" onclick="$(this).closest('tr').remove()">X</button></td>
        </tr>
    `);
    }

    function loadModalStates(callback) {
        $.post("/SalaryConfig/GetPTaxStates", function (data) {
            let ddl = $("#modalPtaxState");
            ddl.empty();

            data.forEach(x => {
                ddl.append(`<option value="${x.StateId}">${x.StateName}</option>`);
            });

            if (callback) callback();
        });
    }
    function fillPTAXSlabs(slabs) {
        $("#modalPtaxSlabBody").empty();
        slabs.forEach(s => {
            addModalPTAXRow();
            let tr = $("#modalPtaxSlabBody tr:last");
            tr.find(".min").val(s.Min);
            tr.find(".max").val(s.Max);
            tr.find(".val").val(s.Value);
        });
    }



    // ---------------- DELETE -----------------
    function deleteRule(id) {
        if (!confirm("Are you sure you want to delete this rule?"))
            return;

        $.post("/SalaryConfig/DeleteStatutoryRule", { statutoryRuleId: id }, function (res) {
            if (res.Code === 1) {
                toastr.success(res.Message);
                loadGrid();
            }
            else {
                toastr.error(res.Message);
            }
        });
    }



    // ---------------- SAVE -----------------
    function saveRule() {

        let ruleId = $("#StatutoryRuleID").val();
        let compId = $("#modalComponent").val();
        let stType = $("#modalComponent option:selected").data("sttype");

        let model = {
            StatutoryRuleID: ruleId || null,
            PayConfigId: compId,
            StatutoryType: stType,
            EffectiveDate: $("#modalEffective").val(),
            MaxLimit: null,
            RoundingType: null,
            LWFMonth: null,
            LWFAmount: null,
            StateId: null,
            SlabJson: ""
        };

        if (stType.includes("PF")) {
            model.MaxLimit = $("#modalPfMax").val();
            model.RoundingType = $("#modalPfRound").val();
        }
        else if (stType.includes("ESIC")) {
            model.MaxLimit = $("#modalEsicMax").val();
            model.RoundingType = $("#modalEsicRound").val();
        }
        else if (stType === "LWF") {
            model.LWFMonth = $("#modalLwfMonth").val();
            model.LWFAmount = $("#modalLwfAmt").val();
        }
        else if (stType === "PTAX") {
            model.StateId = $("#modalPtaxState").val();

            let slabs = [];
            $("#modalPtaxSlabBody tr").each(function () {
                slabs.push({
                    Min: $(this).find(".min").val(),
                    Max: $(this).find(".max").val(),
                    Value: $(this).find(".val").val()
                });
            });

            model.SlabJson = JSON.stringify(slabs);
        }

        $.ajax({
            url: "/SalaryConfig/SaveStatutoryRules",
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify(model),
            success: function (res) {
                if (res.Code === 1) {
                    toastr.success(res.Message);
                    $("#ruleModal").modal("hide");
                    loadGrid();
                }
                else {
                    toastr.error(res.Message);
                }
            }
        });
    } 
    // ---------------- HELPERS -----------------
    function clearModalFields() {
        $("#modalComponent").val("");
        $("#modalEffective").val("");

        $("#modalPfMax,#modalEsicMax,#modalLwfAmt").val("");
        $("#modalPfRound,#modalEsicRound").val("");
        $("#modalLwfMonth").val("January");
        $("#modalPtaxSlabBody").empty();

        $("#modalPfBox,#modalEsicBox,#modalLwfBox,#modalPtaxBox").addClass("hidden");
    }

    function addModalPTAXRow() {
        $("#modalPtaxSlabBody").append(`
        <tr>
            <td><input type="number" class="form-control min"></td>
            <td><input type="number" class="form-control max"></td>
            <td><input type="number" class="form-control val"></td>
            <td><button class="btn-delete" onclick="$(this).closest('tr').remove()">X</button></td>
        </tr>
    `);
    }

    function loadModalComponents() {
        $.post("/SalaryConfig/GetStatutoryComponents", function (data) {
            let ddl = $("#modalComponent");
            ddl.append('<option value="">Select Component</option>');
            data.forEach(x => {
                ddl.append(`<option value="${x.PayConfigId}" data-sttype="${x.StatutoryType}">${x.PayConfigName}</option>`);
            });

            ddl.change(function () {
                let type = $(this).find("option:selected").data("sttype");
                $("#modalPfBox,#modalEsicBox,#modalLwfBox,#modalPtaxBox").addClass("hidden");

                if (type === "PF_EE" || type === "PF_ER") $("#modalPfBox").removeClass("hidden");
                else if (type === "ESIC_EE" || type === "ESIC_ER") $("#modalEsicBox").removeClass("hidden");
                else if (type === "LWF") $("#modalLwfBox").removeClass("hidden");
                else if (type === "PTAX") {
                    $("#modalPtaxBox").removeClass("hidden");
                    loadStates();
                }
            });
        });
    }

    // Load Rounding Types
    function loadRoundingTypes() {
        $.post("/SalaryConfig/GetRoundingTypes", function (data) {

            let pfRound = $("#modalPfRound");
            let esicRound = $("#modalEsicRound");

            // Clear existing
            pfRound.empty();
            esicRound.empty();

            // Load options
            data.forEach(x => {
                pfRound.append(`<option value="${x.RoundingTypeId}">${x.RoundingType}</option>`);
                esicRound.append(`<option value="${x.RoundingTypeId}">${x.RoundingType}</option>`);
            });


        });
    }


    function loadStates() {
        $.post("/SalaryConfig/GetPTaxStates", function (data) {
            let ddl = $("#modalPtaxState");
            ddl.empty();
            data.forEach(x => {
                ddl.append(`<option value="${x.StateId}">${x.StateName}</option>`);
            });
        });
    }
</script>
