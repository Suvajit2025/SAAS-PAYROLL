
@{
    ViewBag.Title = "TaxSlab";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<style>
    .label-design {
        font-weight: 600 !important;
        color: #444444 !important;
    }
</style>
<section role="main" class="content-body">
    <header class="page-header">
    </header>
    <section class="panel" style="position:relative;">
        <header class="panel-heading">
            <h2 class="panel-title">TDS Tax Slab</h2>
            <div class="panel-actions">
                <button id="" onclick="BacktoEmpList();" class="mb-sm mt-xs mr-xs  btn btn-sm btn-default text-sm text-weight-semibold"><i class="text-tertiary fa fa-arrow-circle-left  ml-lg"></i>Back</button>
            </div>
        </header>
        <div class="panel-body">
            <div id="progressOverlay" style="display: none; position: absolute; top: 0; left: 0;
                    width: 100%; height: 100%; background: rgba(255,255,255,0.85); z-index: 9999;
                    justify-content: center; align-items: center; flex-direction: column; text-align: center;">

                <div style="width: 60%; background-color: #ddd; border-radius: 8px; height: 30px; margin-bottom: 10px;">
                    <div id="progressBar" style="height: 100%; width: 0%; background-color: #28a745;
                        text-align: center; color: white; line-height: 30px; border-radius: 8px;">
                        0%
                    </div>
                </div>
                <strong style="color:#555;">TDS Tax Slab</strong>
            </div>


            <form role="form">
                <div class="box-body">
                    <div class="col-md-12">
                        <div class="col-sm-2" style="margin-left:0px;">
                            <div class="form-group">
                                <input type="hidden" id="hdnEmpId" value="0" />
                                <input type="hidden" id="hdnEmployeeId" value="@Model" />
                                <label class="label-design" for="Status">Tax Regime Type<span class="required">*</span></label>
                                <div class="input-group btn-group">
                                    <span class="input-group-addon">
                                        <i class="fa fa-cab"></i>
                                    </span>
                                    <select id="ddlregimetype" class="form-control" value="0"></select>
                                </div>
                            </div>

                        </div>
                        <div class="col-sm-2" style="margin-left:0px;">
                            <div class="form-group">
                                <label class="label-design" for="FinancialYear">Financial Year <span class="required">*</span></label>
                                <div class="input-group">
                                    <span class="input-group-addon">
                                        <i class="fa fa-calendar"></i>
                                    </span>
                                    <select id="ddlFinancialYear" class="form-control" value="0"></select>
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-3" style="margin-left:0px;">
                            <div class="form-group">
                                <label class="label-design" for="Status">From Income<span class="required">*</span></label>
                                <div class="input-group btn-group">
                                    <span class="input-group-addon">
                                        <i class="fa fa-forward"></i>
                                    </span>
                                    <input type="text" id="txtfrom" class="form-control" placeholder="e.g. 0.00" />
                                </div>
                            </div>

                        </div>
                        <div class="col-sm-3" style="margin-left:0px;">
                            <div class="form-group">
                                <label class="label-design" for="Status">To Income<span class="required">*</span></label>
                                <div class="input-group btn-group">
                                    <span class="input-group-addon">
                                        <i class="fa fa-backward"></i>
                                    </span>
                                    <input type="text" id="txtto" class="form-control" placeholder="e.g.25000.00" />
                                </div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="form-group">
                                <label class="label-design" for="Status">Tax Rate(%) (&#8377;&nbsp;)<span class="required">*</span></label>
                                <div class="input-group btn-group">
                                    <span class="input-group-addon">
                                        <i class="fa fa-dollar"></i>
                                    </span>
                                    <input type="text" id="txtrate" class="form-control" placeholder="e.g. 0.00" />
                                </div>
                            </div>
                        </div>
                    </div>
                    @*<div class="col-md-12 mt-sm">
                        <div class="col-sm-2" style="margin-left:0px;">
                            <div class="form-group">
                                <label class="label-design" for="Status">From Income<span class="required">*</span></label>
                                <div class="input-group btn-group">
                                    <span class="input-group-addon">
                                        <i class="fa fa-forward"></i>
                                    </span>
                                    <input type="text" id="txtfrom" class="form-control" placeholder="e.g. 0.00" />
                                </div>
                            </div>

                        </div>
                        <div class="col-sm-2" style="margin-left:0px;">
                            <div class="form-group">
                                <label class="label-design" for="Status">To Income<span class="required">*</span></label>
                                <div class="input-group btn-group">
                                    <span class="input-group-addon">
                                        <i class="fa fa-backward"></i>
                                    </span>
                                    <input type="text" id="txtto" class="form-control" placeholder="e.g.25000.00" />
                                </div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="form-group">
                                <label class="label-design" for="Status">Tax Rate(%) (&#8377;&nbsp;)<span class="required">*</span></label>
                                <div class="input-group btn-group">
                                    <span class="input-group-addon">
                                        <i class="fa fa-dollar"></i>
                                    </span>
                                    <input type="text" id="txtrate" class="form-control" placeholder="e.g. 0.00" />
                                </div>
                            </div>
                        </div>
                    </div>*@

                </div>
            </form>
            <div class="box-footer mt-lg" style="text-align:center;">
                <div class="col-md-12">
                    <button type="button" id="btnEmpCTCSave" class="btn btn-tertiary" onclick="return validateAndAddRow();" style="margin:10px;">
                        <i class="fa fa-plus-square space-right"></i> Add Tax Slab
                    </button>
                </div>

            </div>
        </div>
    </section>
    <!-- New card for table -->
    <section class="panel mt-3">
        <header class="panel-heading">
            <h2 class="panel-title">TDS Tax Slab List</h2>
        </header>
        <div class="panel-body">
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th>Tax Regime</th>
                        <th>Financial Year</th>
                        <th>From Income</th>
                        <th>To Income</th>
                        <th>Rate(%)(₹)</th>
                        <th style="width: 13%; text-align: center">Action</th>
                    </tr>
                </thead>
                <tbody id="tdstaxbody"></tbody>
            </table>
            <div class="text-center mt-3">
                <button type="button" class="btn btn-success" onclick="savetdstaxslab()">
                    <i class="fa fa-save"></i> Save Tax Slab
                </button>
            </div>
        </div>
    </section>
</section>
<script>
    $(document).ready(function () {
        loadmasterData();
        LoadTdsTaxSlab();
    }); 
    function loadmasterData() {
        const empId = "0";
        $.ajax({
            url: '/PayrollTds/GetTDSMasterData',
            type: 'GET',
            data: { empId: empId },
            dataType: 'json',
            success: function (data) {
                populateFinancialYearDropdown('#ddlFinancialYear', data.financialYears, 'IDFinancialYear', 'FinancialYearCode', 'AssessmentYearCode');
                populateDropdown('#ddlregimetype', data.taxRegimes, 'RegimeId', 'RegimeName'); 
            },
            error: function (err) {
                console.error('Failed to load master data:', err);
            }
        });
    }
    function populateFinancialYearDropdown(selector, data, valueField, textField, dataAttrField) {
        var dropdown = $(selector);
        dropdown.empty();
        dropdown.append($('<option></option>').val("0").html('-- Select --'));
        $.each(data, function (i, item) {
            // Add assessment year as data attribute
            dropdown.append(
                $('<option></option>')
                    .val(item[valueField])
                    .html(item[textField])
                    .attr('data-assessmentyear', item[dataAttrField])
            );
        });
    } 
    function populateDropdown(selector, data, valueField, textField) {
        var dropdown = $(selector);
        dropdown.empty();
        dropdown.append($('<option></option>').val("0").html('-- Select --'));
        $.each(data, function (i, item) {
            dropdown.append($('<option></option>').val(item[valueField]).html(item[textField]));
        });
    }
</script>
<script>
    function validateAndAddRow() {
        const regimeTypeId = $("#ddlregimetype").val();
        const regimeTypetext = $("#ddlregimetype option:selected").text();
        const financialyearId = $("#ddlFinancialYear").val();
        const financialyeartext = $("#ddlFinancialYear option:selected").text();
        const assessmentyeartext = $("#ddlFinancialYear option:selected").data("assessmentyear");
        const fromincome = $("#txtfrom").val();
        const toincome = $("#txtto").val();
        const taxrate = $("#txtrate").val();

        if (regimeTypeId === "0" || financialyearId === "0" || !fromincome || !toincome || !taxrate) {
            alert("Please fill all required (*) fields.");
            return;
        }

        const row = `
            <tr>
                <td data-regimeTypeId="${regimeTypeId}">${regimeTypetext}</td>
                <td data-financialyear="${financialyeartext}">${financialyeartext}</td>
                <td data-fromincome="${fromincome}">${fromincome}</td>
                <td data-toincome="${toincome}">${toincome}</td>
                <td data-tdsrate="${taxrate}">${taxrate}</td> 
                <td style="display:none;" data-assessmentyeartext="${assessmentyeartext}">${assessmentyeartext}</td> 
                <td>
                    <button type="button" class="btn btn-sm btn-warning" onclick="editRow(this)">Edit</button>
                    <button type="button" class="btn btn-sm btn-danger" onclick="deleteRow(this)">Delete</button>
                </td>
            </tr>
        `;
        $("#tdstaxbody").append(row);
        // Reset form
        $("#txtfrom").val("");
        $("#txtto").val(""); 
        $("#txtrate").val(""); 
        $("#ddlregimetype").val("0");
        $("#ddlFinancialYear").val("0");

       
    }
    function deleteRow(button) {
        if (confirm("Are you sure you want to delete this row?")) {
            $(button).closest("tr").remove();
        }
    }

    function editRow(button) {
        const row = $(button).closest("tr");
        const cells = row.find("td");

        $("#ddlregimetype").val(cells.eq(0).data("regimetypeid"));
        // FinancialYear by matching its visible text
        const fyText = cells.eq(1).text().trim();
        $("#ddlFinancialYear option").each(function () {
            if ($(this).text().trim() === fyText) {
                $(this).prop("selected", true);
                return false; // stop the loop
            }
        });
        $("#txtfrom").val(cells.eq(2).data("fromincome"));
        $("#txtto").val(cells.eq(3).data("toincome"));
        $("#txtrate").val(cells.eq(4).data("tdsrate")); 
        row.remove(); // Remove row after editing
    }
    
</script>
<script>
    function savetdstaxslab() {
        const rows = $("#tdstaxbody tr");
        if (rows.length === 0) {
            alert("No Tds Tax Slab to save.");
            return;
        }
        const dataToSave = [];
        rows.each(function () {
            const cells = $(this).find("td");
            dataToSave.push({
                Regimetypeid: cells.eq(0).data("regimetypeid"),
                FinancialYear: cells.eq(1).data("financialyear"),
                Fromincome: cells.eq(2).data("fromincome"),
                Toincome: cells.eq(3).data("toincome"),
                Tdsrate: cells.eq(4).data("tdsrate") ,
                AssessmentYear: cells.eq(5).data("assessmentyeartext") // Assuming this is the assessment year text
            });
        });
        $.ajax({
            url: '/PayrollTds/SaveTdsTaxSlab',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(dataToSave),
            success: function (response) {
                if (response.success) {
                    alert("TDS Tax Slab saved successfully.");
                    $("#tdstaxbody").empty(); // Clear the table body
                } else {
                    alert("Failed to save TDS Tax Slab: " + response.message);
                }
            },
            error: function (err) {
                console.error('Error saving TDS Tax Slab:', err);
                alert("An error occurred while saving TDS Tax Slab.");
            }
        });
    }
    function LoadTdsTaxSlab() {
        $.ajax({
            type: "GET",
            url: "/PayrollTds/GetTdsTaxSlab",
            dataType: "json",
            success: function (items) {
                const tbody = $("#tdstaxbody").empty();
                console.log(items)
                items.forEach(item => tbody.append(renderDeductionRow(item)));
            },
            error: function (xhr) {
                console.error("Error loading deduction rules:", xhr.responseText);
                alert("Failed to load deduction rules from server.");
            }
        });
    }
    // Reusable row-builder
    function renderDeductionRow(item) {
        return `
         <tr>
           <td data-regimeTypeId="${item.Regimetypeid}">${item.RegimetypeName}</td>
           <td data-financialyear="${item.FinancialYear}">${item.FinancialYear}</td>
           <td data-fromincome="${item.Fromincome}">${item.Fromincome}</td>
           <td data-toincome="${item.Toincome}">${item.Toincome}</td>
           <td data-tdsrate="${item.Tdsrate}">${item.Tdsrate}</td> 
           <!-- hidden cells to carry extra data for edit/save -->

           <td style="display:none;" data-assessmentyeartext="${item.AssessmentYear}">${item.AssessmentYear}</td> 
           <td>
             <button class="btn btn-sm btn-warning" onclick="editRow(this)">Edit</button>
             <button class="btn btn-sm btn-danger"  onclick="deleteRow(this)">Delete</button>
           </td>
         </tr>`;
    }
    function BacktoEmpList() {
        window.location.href = "/Dashboard/Index";
    }
</script>
 