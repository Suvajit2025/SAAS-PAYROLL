@{
    ViewBag.Title = "Salary Register";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<section role="main" class="content-body">
    <header class="page-header">
        <h2 style="font-weight:700; margin:0;">Salary Register</h2>

    </header>

    <section class="panel">
        <header class="panel-heading" style="display:flex; justify-content:space-between; align-items:center;">

            <div style="display:flex; align-items:center;">
                <button type="button" class="btn btn-default btn-sm" onclick="window.history.back();" style="margin-right: 15px;">
                    <i class="fa fa-arrow-left text-muted"></i> Back
                </button>

                <h2 class="panel-title" style="margin:0; line-height:1;">
                    <i class="fa fa-money text-primary mr-sm"></i> Employee Salary Processing
                </h2>
            </div>

            <div class="btn-group">

                <button onclick="downloadBulkPayslips()" class="btn btn-default btn-sm">
                    <i class="fa fa-file-pdf-o text-danger mr-xs"></i> Bulk Payslips
                </button>

                <button onclick="processPayment()" class="btn btn-success btn-sm">
                    <i class="fa fa-check-circle mr-xs"></i> Mark as Paid
                </button>
            </div>
        </header>

        <div class="panel-body">

            <div class="row mb-md">
                <div class="col-sm-4">
                    <div class="input-group">
                        <span class="input-group-addon" style="background:#fff; border-right:none; border-radius:4px 0 0 4px;">
                            <i class="fa fa-search text-muted"></i>
                        </span>
                        <input type="text" id="searchInput" class="form-control" style="border-left:none;" placeholder="Search Name or Emp Code..." onkeyup="applyFilters()">
                    </div>
                </div>
                <div class="col-sm-8 text-right">
                    <div class="btn-group">
                        <button class="btn btn-default btn-sm" onclick="toggleFilterPanel()">
                            <i class="fa fa-filter mr-xs"></i> Filter <span id="filterCount" class="badge">3</span>
                        </button>
                        <button class="btn btn-default btn-sm" onclick="exportExcel()">
                            <i class="fa fa-file-excel-o mr-xs" style="color:#16a34a;"></i> Export
                        </button>
                        <button class="btn btn-default btn-sm" onclick="refreshGrid()">
                            <i class="fa fa-refresh"></i>
                        </button>
                    </div>
                </div>
            </div>


            <div id="filterPanel" style="display:block; background:#f8fafc; border:1px solid #e2e8f0; border-radius:6px; padding:15px; margin-bottom:15px;">
                <div class="row">

                    <!-- Month (JS bind) -->
                    <div class="col-md-2">
                        <label class="control-label text-xs text-muted text-weight-bold">Month</label>
                        <select id="fltMonth" class="form-control input-sm">
                            <!-- JS will bind -->
                        </select>
                    </div>

                    <!-- Year (JS bind) -->
                    <div class="col-md-2">
                        <label class="control-label text-xs text-muted text-weight-bold">Year</label>
                        <select id="fltYear" class="form-control input-sm">
                            <!-- JS will bind -->
                        </select>
                    </div>

                    <!-- Company (DB bind) -->
                    <div class="col-md-3">
                        <label class="control-label text-xs text-muted text-weight-bold">Company</label>
                        <select id="fltCompany" class="form-control input-sm">
                            <option value="">All Companies</option>
                        </select>
                    </div>

                    <!-- Pay Group (DB bind) -->
                    <div class="col-md-3">
                        <label class="control-label text-xs text-muted text-weight-bold">Pay Group</label>
                        <select id="fltPayGroup" class="form-control input-sm">
                            <option value="">All Groups</option>
                        </select>
                    </div>

                    <!-- Payroll Status (your payroll process status, not employee active/inactive) -->
                    <div class="col-md-2">
                        <label class="control-label text-xs text-muted text-weight-bold">Process Status</label>
                        <select id="fltStatus" class="form-control input-sm">
                            <option value="">All</option>
                            <option value="1">Draft</option>
                            <option value="2" selected>Finalized</option>
                        </select>
                    </div>

                </div>

                <div class="row mt-sm">
                    <div class="col-md-12 text-right">
                        <button type="button" class="btn btn-xs btn-default" id="btnClearFilters">
                            <i class="fa fa-times"></i> Clear All
                        </button>
                    </div>
                </div>
            </div>
            <div class="table-responsive">
                <table class="table table-striped table-hover mb-none">
                    <thead>
                        <tr>
                            <th style="width:30px;"><input type="checkbox" id="chkAll"></th>
                            <th style="width:80px;">Emp Info</th>
                            <th style="width:150px;">Company & Group</th>
                            <th class="text-right">Basic</th>
                            <th class="text-right">Allowances</th>
                            <th class="text-right">Gross</th>
                            <th class="text-right text-danger">Deduction</th>
                            <th class="text-right text-primary">Net Pay</th>
                            <th class="text-center" style="width:40px;">Salary Process</th>
                            <th class="text-center" style="width:40px;">Pay Status</th>
                            <th class="text-center">Action</th>
                        </tr>
                    </thead>
                    <tbody id="gridBody">
                    </tbody>
                </table>
            </div>

            <div class="row mt-lg" style="align-items:center;">
                <div class="col-sm-6">
                    <div id="paginationInfo" class="text-muted text-xs" style="font-weight:500;">Showing 0 to 0 of 0 entries</div>
                </div>
                <div class="col-sm-6 text-right">
                    <div class="btn-group">
                        <button class="btn btn-default btn-sm" disabled><i class="fa fa-chevron-left"></i></button>
                        <button class="btn btn-primary btn-sm">1</button>
                        <button class="btn btn-default btn-sm"><i class="fa fa-chevron-right"></i></button>
                    </div>
                </div>
            </div>
        </div>
    </section>
</section>

<div class="modal fade" id="BankModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header bg-primary" style="padding: 15px;">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true" style="color:white;">&times;</span></button>
                <h4 class="modal-title" style="color:white; margin:0;"><i class="fa fa-university mr-xs"></i>Bank Details</h4>
            </div>
            <div class="modal-body" style="background:#fdfdfd;">
                <div class="row mb-sm" style="border-bottom:1px solid #eee; padding-bottom:5px;">
                    <div class="col-xs-5 text-muted text-weight-bold">Employee Name</div>
                    <div class="col-xs-7 text-primary text-weight-semibold" id="lblModalName">--</div>
                </div>
                <div class="row mb-sm" style="border-bottom:1px solid #eee; padding-bottom:5px;">
                    <div class="col-xs-5 text-muted text-weight-bold">Bank Name</div>
                    <div class="col-xs-7 text-dark" id="lblModalBank">--</div>
                </div>
                <div class="row mb-sm" style="border-bottom:1px solid #eee; padding-bottom:5px;">
                    <div class="col-xs-5 text-muted text-weight-bold">Branch</div>
                    <div class="col-xs-7 text-dark" id="lblModalBranch">--</div>
                </div>
                <div class="row mb-sm" style="border-bottom:1px solid #eee; padding-bottom:5px;">
                    <div class="col-xs-5 text-muted text-weight-bold">IFSC Code</div>
                    <div class="col-xs-7 text-dark" style="font-family:monospace;" id="lblModalIfsc">--</div>
                </div>
                <div class="row">
                    <div class="col-xs-5 text-muted text-weight-bold">Account No</div>
                    <div class="col-xs-7 text-success text-weight-bold" style="font-size:1.1em; font-family:monospace;" id="lblModalAcct">--</div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="MarkPaidModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document" style="max-width:420px;">
        <div class="modal-content">
            <div class="modal-header bg-success" style="padding: 15px;">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true" style="color:white;">&times;</span>
                </button>
                <h4 class="modal-title" style="color:white; margin:0;">
                    <i class="fa fa-check-circle mr-xs"></i> Mark Salary as Paid
                </h4>
            </div>

            <div class="modal-body">
                <div class="alert alert-info" style="margin-bottom:10px;">
                    Selected Employees: <b id="lblSelectedCount">0</b>
                </div>

                <div class="form-group">
                    <label class="control-label">Paid Date</label>
                    <input type="date" class="form-control" id="txtPaidDate">
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn btn-default" data-dismiss="modal">Cancel</button>
                <button class="btn btn-success" id="btnConfirmPaid">
                    <i class="fa fa-check"></i> Paid
                </button>
            </div>
        </div>
    </div>
</div>
<!-- Skipped Employees Modal -->
<div class="modal fade" id="SkippedEmployeeModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-md" role="document">
        <div class="modal-content">

            <div class="modal-header bg-warning" style="padding:15px;">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true" style="color:white;">&times;</span>
                </button>
                <h4 class="modal-title" style="color:white; margin:0;">
                    <i class="fa fa-exclamation-triangle mr-xs"></i> Skipped Employees
                </h4>
            </div>

            <div class="modal-body" style="background:#fdfdfd;">
                <!-- JS will inject table here -->
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">
                    Close
                </button>
            </div>

        </div>
    </div>
</div>


<link href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" rel="stylesheet" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>

<script>
    $(document).ready(function () {
        $("#fltStatus").val("");
        loadFilterData();
    });
    let pageNumber = 1;
    let pageSize = 50;

    /* Apply -> reset to page 1 and reload grid */
    function applyFilters() {
        pageNumber = 1;
        refreshGrid(); // your existing ajax grid load
    }

    /* Clear all filters -> reset dropdowns + search and reload */
    function clearFilters() {

        // reset month/year to current
        const now = new Date();

        const prev = new Date(now.getFullYear(), now.getMonth() - 1, 1);

        const defaultMonth = String(prev.getMonth() + 1);
        const defaultYear = String(prev.getFullYear());

        $("#fltMonth").val(defaultMonth);
        $("#fltYear").val(defaultYear);

        // reset company/paygroup/status
        $("#fltCompany").val("");   // All Companies
        $("#fltPayGroup").val("");  // All Groups
        $("#fltStatus").val("");    // All

        // reset search
        $("#searchInput").val("");

        // reload
        applyFilters();
    }
    function loadFilterData() {

        // 1) Bind Month/Year (static in JS)
        bindMonthYear();

        // 2) Bind Company + PayGroup (from DB)
        $.ajax({
            url: "/PayrollSalaryReport/GetFilterData",
            type: "GET",
            dataType: "json",
            success: function (res) {
                if (!res || !res.success) return;

                // Company
                const companies = [{ Value: "", Text: "All Companies" }].concat(res.companies || []);
                bindSelect("#fltCompany", companies, "");

                // PayGroup
                const payGroups = [{ Value: "", Text: "All Groups" }].concat(res.payGroups || []);
                bindSelect("#fltPayGroup", payGroups, "");

                // 3) First load grid
                refreshGrid();
            },
            error: function () {
                // still allow grid with static month/year
                refreshGrid();
            }
        });
    }

    function bindMonthYear() {
        // MONTHS
        const monthList = [
            { Value: "1", Text: "January" },
            { Value: "2", Text: "February" },
            { Value: "3", Text: "March" },
            { Value: "4", Text: "April" },
            { Value: "5", Text: "May" },
            { Value: "6", Text: "June" },
            { Value: "7", Text: "July" },
            { Value: "8", Text: "August" },
            { Value: "9", Text: "September" },
            { Value: "10", Text: "October" },
            { Value: "11", Text: "November" },
            { Value: "12", Text: "December" }
        ];

        // YEARS (example: current year back 5 years; adjust as needed)
        const currentYear = new Date().getFullYear();
        const yearList = [];
        for (let y = currentYear; y >= currentYear - 5; y--) {
            yearList.push({ Value: String(y), Text: String(y) });
        }

        // Default selection (example: current month/year)
        const now = new Date();

        const prev = new Date(now.getFullYear(), now.getMonth() - 1, 1);

        const defaultMonth = String(prev.getMonth() + 1);
        const defaultYear = String(prev.getFullYear());

        bindSelect("#fltMonth", monthList, defaultMonth);
        bindSelect("#fltYear", yearList, defaultYear);
    }

    function bindSelect(selector, list, selectedValue) {
        const $ddl = $(selector);
        $ddl.empty();

        $.each(list, function (i, x) {
            $ddl.append(`<option value="${x.Value}">${x.Text}</option>`);
        });

        if (selectedValue !== undefined && selectedValue !== null) {
            $ddl.val(selectedValue);
        }
    }

    /* Attach events via jQuery (recommended instead of inline onchange) */
    $(document).on("change", "#fltMonth,#fltYear,#fltCompany,#fltPayGroup,#fltStatus", function () {
        applyFilters();
    });

    $(document).on("click", "#btnApplyFilters", function () {
        applyFilters();
    });

    $(document).on("click", "#btnClearFilters", function () {
        clearFilters();
    });
    function toggleFilterPanel() {
        var x = document.getElementById("filterPanel");
        if (x.style.display === "none") {
            x.style.display = "block";
        } else {
            x.style.display = "none";
        }
    }

    function openBankModal(empId, name) {

        // Set name immediately (good UX)
        $('#lblModalName').text(name);

        // Show loading placeholders
        $('#lblModalBank').text('Loading...');
        $('#lblModalBranch').text('Loading...');
        $('#lblModalIfsc').text('Loading...');
        $('#lblModalAcct').text('Loading...');

        $('#BankModal').modal('show');

        $.ajax({
            url: '/PayrollSalaryReport/GetEmployeeBank',
            type: 'GET',
            dataType: 'json',
            data: { employeeId: empId },
            success: function (res) {

                if (!res || !res.success) {
                    $('#lblModalBank').text('—');
                    $('#lblModalBranch').text('—');
                    $('#lblModalIfsc').text('—');
                    $('#lblModalAcct').text('—');
                    toastr.warning(res?.message || 'Bank details not found');
                    return;
                }

                $('#lblModalBank').text(res.bankName || '—');
                $('#lblModalBranch').text(res.branch || '—');
                $('#lblModalIfsc').text(res.ifsc || '—');
                $('#lblModalAcct').text(res.accountNo || '—');
            },
            error: function () {
                $('#lblModalBank').text('—');
                $('#lblModalBranch').text('—');
                $('#lblModalIfsc').text('—');
                $('#lblModalAcct').text('—');
                toastr.error('Server error while loading bank details');
            }
        });
    }



    function refreshGrid() {

        const month = parseInt($("#fltMonth").val() || "0", 10);
        const year = parseInt($("#fltYear").val() || "0", 10);

        // empty value => NULL on server
        const companyId = $("#fltCompany").val() ? parseInt($("#fltCompany").val(), 10) : null;
        const payGroupId = $("#fltPayGroup").val() ? parseInt($("#fltPayGroup").val(), 10) : null;

        // payroll process status (Draft=1, Finalized=2) OR null
        const status = $("#fltStatus").val() ? parseInt($("#fltStatus").val(), 10) : null;

        const search = ($("#searchInput").val() || "").trim();

        if (!month || !year) {
            $("#gridBody").html('<tr><td colspan="11" class="text-center p-lg text-muted">Select Month and Year.</td></tr>');
            $("#paginationInfo").text("Showing 0 to 0 of 0 entries");
            return;
        }

        // optional loading row
        $("#gridBody").html('<tr><td colspan="11" class="text-center p-lg text-muted"><i class="fa fa-spinner fa-spin"></i> Loading...</td></tr>');

        $.ajax({
            url: "/PayrollSalaryReport/GetGrid",   // controller action from previous message
            type: "GET",
            dataType: "json",
            data: {
                month: month,
                year: year,
                companyId: companyId,
                payGroupId: payGroupId,
                search: search,
                status: status,
                pageNumber: pageNumber,
                pageSize: pageSize
            },
            success: function (res) {
                if (!res || !res.success) {
                    $("#gridBody").html('<tr><td colspan="11" class="text-center p-lg text-muted">No records found.</td></tr>');
                    $("#paginationInfo").text("Showing 0 to 0 of 0 entries");
                    return;
                }

                const rows = Array.isArray(res.rows) ? res.rows : [];
                renderSalaryRegisterGrid(rows);

                const total = Number(res.totalRows || 0);
                const from = total === 0 ? 0 : ((pageNumber - 1) * pageSize + 1);
                const to = Math.min(pageNumber * pageSize, total);
                $("#paginationInfo").text(`Showing ${from} to ${to} of ${total} entries`);
            },
            error: function () {
                $("#gridBody").html('<tr><td colspan="11" class="text-center p-lg text-danger">Server error while loading data.</td></tr>');
                $("#paginationInfo").text("Showing 0 to 0 of 0 entries");
            }
        });
    }
    /* Renders server rows into your table layout */
    function renderSalaryRegisterGrid(rows) {

        const $tbody = $("#gridBody");
        $tbody.empty();

        if (!rows.length) {
            $tbody.html('<tr><td colspan="11" class="text-center p-lg text-muted">No records found.</td></tr>');
            return;
        }

        rows.forEach(function (r) {

            const processBadge = (Number(r.Status) === 2)
                ? '<span class="label label-success">Finalize</span>'
                : '<span class="label label-warning">Draft</span>';

            // Pay status not in your table yet; keeping Pending as default (update when you add payment table)

            const payBadge = (Number(r.PaidStatus) === 1)
                ? '<span class="label label-success">Paid</span>'
                : '<span class="label label-warning">Pending</span>';
            const basic = Number(r.BasicAmount || 0);
            const gross = Number(r.TotalGross || 0);
            const add = Number(r.TotalAddition || 0);
            const ded = Number(r.TotalDeduction || 0);
            const net = Number(r.TotalTakeHome || 0);
            const allowances = Number(r.AllowancesAmount || 0);

            const tr = `
            <tr>
                <td style="width:30px;"><input type="checkbox" class="row-check" value="${r.PayrollProcessEmployeeID}" data-empid="${Number(r.EmployeeID || 0)}"></td>

                <td style="width:80px;">
                    <div style="font-weight:600; color:#333;">${escapeHtml(r.EmployeeName || '')}</div>
                    <div class="text-xs text-muted">${escapeHtml(r.EmployeeCode || '')}</div>
                </td>

                <td style="width:200px;">
                    <div class="text-sm">${escapeHtml(r.CompanyName || '')}</div>
                    <div class="text-xs text-muted">${escapeHtml(r.PayGroupName || '')}</div>
                </td>

                <td class="text-right">${basic.toLocaleString('en-IN')}</td>
                <td class="text-right">${allowances.toLocaleString('en-IN')}</td>
                <td class="text-right text-weight-bold">${gross.toLocaleString('en-IN')}</td>
                <td class="text-right text-danger">${ded.toLocaleString('en-IN')}</td>
                <td class="text-right text-primary text-weight-bold">${net.toLocaleString('en-IN')}</td>

                <td class="text-center" style="width:40px;">${processBadge}</td>
                <td class="text-center" style="width:40px;">${payBadge}</td>

                <td class="text-center">
                    <button class="btn btn-xs btn-default" onclick="openBankModal(${r.EmployeeID || 0}, '${escapeHtml(r.EmployeeName || '')}')" title="Bank Info">
                        <i class="fa fa-university"></i>
                    </button>
                    <button class="btn btn-xs btn-default" onclick="downloadPayslip(${r.PayrollProcessEmployeeID})" title="Download PDF">
                        <i class="fa fa-file-pdf-o"></i>
                    </button>
                </td>
            </tr>
        `;
            $tbody.append(tr);
        });
    }
    function getSelectedEmployeeIds() {
        return $(".row-check:checked").map(function () {
            return $(this).data("empid");
        }).get();
    }
    function escapeHtml(text) {
        return String(text ?? "")
            .replaceAll("&", "&amp;")
            .replaceAll("<", "&lt;")
            .replaceAll(">", "&gt;")
            .replaceAll('"', "&quot;")
            .replaceAll("'", "&#039;");
    }

    // Select All
    $(document).on("change", "#chkAll", function () {
        const isChecked = $(this).is(":checked");
        $(".row-check").prop("checked", isChecked);
    });

    // Keep header checkbox in sync
    $(document).on("change", ".row-check", function () {
        const total = $(".row-check").length;
        const selected = $(".row-check:checked").length;
        $("#chkAll").prop("checked", total > 0 && total === selected);
    });
    // Your button already calls processPayment()
    function processPayment() {
        const ids = getSelectedEmployeeIds();
        if (!ids.length) {
            alert("Please select at least one employee.");
            return;
        }

        $("#lblSelectedCount").text(ids.length);

        // default date = today
        const d = new Date();
        const yyyy = d.getFullYear();
        const mm = String(d.getMonth() + 1).padStart(2, "0");
        const dd = String(d.getDate()).padStart(2, "0");
        $("#txtPaidDate").val(`${yyyy}-${mm}-${dd}`);

        $("#MarkPaidModal").modal("show");
    }

    $(document).on("click", "#btnConfirmPaid", function () {
        const ids = getSelectedEmployeeIds();
        //alert(ids.length);
        const paidDate = $("#txtPaidDate").val();

        if (!ids.length) { alert("No employees selected."); return; }
        if (!paidDate) { alert("Please select Paid Date."); return; }

        $("#btnConfirmPaid").prop("disabled", true).html('<i class="fa fa-spinner fa-spin"></i> Processing...');

        //$.ajax({
        //    url: "/PayrollSalaryReport/MarkPaid",
        //    type: "POST",
        //    contentType: "application/json; charset=utf-8",
        //    dataType: "json",
        //    data: JSON.stringify({
        //        month: parseInt($("#fltMonth").val(), 10),
        //        year: parseInt($("#fltYear").val(), 10),
        //        paidDate: paidDate,
        //        payrollProcessEmployeeIds: ids.join(",")      // ✅ send EmployeeIDs
        //    }),
        //    success: function (res) {
        //        if (!res || !res.success) {
        //            alert(res?.message || "Failed to mark paid.");
        //            return;
        //        }

        //        $("#MarkPaidModal").modal("hide");
        //        $("#chkAll").prop("checked", false);
        //        refreshGrid();
        //    },
        //    error: function () {
        //        alert("Server error while marking paid.");
        //    },
        //    complete: function () {
        //        $("#btnConfirmPaid").prop("disabled", false).html('<i class="fa fa-check"></i> Paid');
        //    }
        //});
        $.ajax({
            url: "/PayrollSalaryReport/MarkPaid",
            type: "POST",
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            data: JSON.stringify({
                month: parseInt($("#fltMonth").val(), 10),
                year: parseInt($("#fltYear").val(), 10),
                paidDate: paidDate,
                payrollProcessEmployeeIds: ids.join(",")
            }),
            success: function (res) {

                if (!res || !res.success) {
                    alert(res?.message || "Failed to mark paid.");
                    return;
                }

                // ✅ Success message
                toastr.success(res.message || "Payment processed");

                // ✅ Optional summary toast
                toastr.info(
                    `Updated: ${res.paidUpdated}, Paid: ${res.paidEmployees}/${res.totalEmployees}`
                );

                // ⚠️ Show skipped employees (if any)
                if (res.skippedEmployees && res.skippedEmployees.length > 0) {
                    showSkippedEmployees(res.skippedEmployees);
                }

                // UI reset
                $("#MarkPaidModal").modal("hide");
                $("#chkAll").prop("checked", false);

                refreshGrid();
            },
            error: function () {
                alert("Server error while marking paid.");
            },
            complete: function () {
                $("#btnConfirmPaid")
                    .prop("disabled", false)
                    .html('<i class="fa fa-check"></i> Paid');
            }
        });

    });

    function showSkippedEmployees(list) {

        let html = `
        <table class="table table-sm table-bordered">
            <thead>
                <tr>
                    <th>Employee</th>
                    <th>Reason</th>
                </tr>
            </thead>
            <tbody>
    `;

        list.forEach(e => {
            html += `
            <tr>
                <td>${e.EmployeeName}</td>
                <td>${e.SkipReason}</td>
            </tr>`;
        });

        html += `</tbody></table>`;

        $("#SkippedEmployeeModal .modal-body").html(html);
        $("#SkippedEmployeeModal").modal("show");
    }

    function exportExcel() {

        const month = parseInt($("#fltMonth").val() || "0", 10);
        const year = parseInt($("#fltYear").val() || "0", 10);

        const companyId = $("#fltCompany").val() ? parseInt($("#fltCompany").val(), 10) : null;
        const payGroupId = $("#fltPayGroup").val() ? parseInt($("#fltPayGroup").val(), 10) : null;
        const status = $("#fltStatus").val() ? parseInt($("#fltStatus").val(), 10) : null;
        const search = ($("#searchInput").val() || "").trim();

        if (!month || !year) {
            alert("Please select Month and Year");
            return;
        }

        // 🔹 Build query string
        const qs = $.param({
            month: month,
            year: year,
            companyId: companyId,
            payGroupId: payGroupId,
            status: status,
            search: search
        });

        // 🔹 Trigger download (AJAX is NOT suitable for file streams)
        window.location.href = `/PayrollSalaryReport/ExportExcel?${qs}`;
    }

</script>