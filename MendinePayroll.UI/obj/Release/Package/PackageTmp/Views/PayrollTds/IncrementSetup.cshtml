@model MendinePayroll.Models.EmployeeSalaryModel
@{
    ViewBag.Title = "Increment SetUp";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<!--<section role="main" class="content-body">
    <header class="page-header">
        <h2>Increment SetUp</h2>
    </header>

    <style>
        .form-inline select,
        .form-inline label {
            margin-right: 8px;
        }

        .form-inline select {
            width: 160px;
        }

        .form-inline {
            display: flex;
            align-items: center;
            flex-wrap: nowrap;
            gap: 10px;
        }
    </style>


    <section class="panel">
        <header class="panel-heading">
            <div class="panel-actions">
                <button onclick="BacktoEmpList();" class="mb-sm mt-xs mr-xs btn btn-sm btn-default text-sm text-weight-semibold">
                    <i class="text-tertiary fa fa-arrow-circle-left ml-lg"></i> Back
                </button>
            </div>
            <h2 class="panel-title">Employee Increment SetUp</h2>
        </header>

        <div class="modal-body">
            <form class="form-inline d-flex align-items-center flex-wrap gap-2" style="gap:10px;">

                <label>Financial Year</label>
                @Html.DropDownListFor(m => m.FinancialYear, Model.YearList,
                    new { @class = "form-control", id = "ddlyear" })-->
@*<label style="display:none">Department</label>
    @Html.DropDownListFor(m => m.DepartmentId, Model.DepartmentList,
        new { @class = "form-control", id = "ddldepartment", style = "display:none;" })*@

<!--<label>Pay Group</label>

    @Html.DropDownListFor(m => m.PayGroupId, Model.PayGroupList,
        new { @class = "form-control", id = "ddlpayGroup" })

    <label>Employee</label>
    @Html.DropDownListFor(m => m.Empid, Model.masterModel.selectListItems,
        new { @class = "form-control", id = "EmployeeName" })

    <label>PageRow</label>
    <select class="form-control Pagenum" onchange="GetSearchbypagenumberResult(1);" id="Pagrow" name="Numberofrow">
        <option selected value="10">10</option>
        <option value="25">25</option>
        <option value="50">50</option>
        <option value="100">100</option>
    </select>

</form>-->
<!-- Increment type -->
<!--<div style="white-space: nowrap;">
                <label style="margin-right:10px;">Increment Type :</label>

                <label class="radio-inline">
                    <input type="radio" name="IncrementType" id="rdoPercent" value="P" checked> Percentage
                </label>

                <label class="radio-inline">
                    <input type="radio" name="IncrementType" id="rdoAmount" value="A"> Fixed Amount
                </label>
            </div>


            <table class="table table-bordered table-sm mt-2">
                <thead class="table-light">
                    <tr><th>Pay Component</th><th>Increment Value(<span id="lblUnit">%</span>)</th></tr>
                </thead>
                <tbody id="payConfigBody">
                    <tr><td colspan="2">Select a Pay Group to load components.</td></tr>
                </tbody>
            </table>

            <div class="form-inline d-flex align-items-center flex-wrap gap-2" style="justify-content: center;">
                <button type="button" id="btnGenerate" class="mb-sm mt-xs mr-xs btn btn-sm btn-primary">
                    <i class="fa fa-cogs me-1"></i>Generate Increment
                </button>
            </div>
            <div id="pivotResult" class="mt-4"></div>
</section>
</section>-->
<section role="main" class="content-body">
    <header class="page-header">
        <h2>Increment SetUp</h2>
    </header>

    <style>
        .form-row {
            margin-bottom: 12px;
        }

        .panel-body label {
            font-weight: 600;
        }

        #pivotResult {
            margin-top: 20px;
        }
        #pivotContent table th,
        #pivotContent table td {
            text-align: center;
            vertical-align: middle;
        }
    </style>

    <section class="panel">
        <header class="panel-heading">
            <div class="panel-actions">
                <button onclick="BacktoEmpList();" class="btn btn-sm btn-default">
                    <i class="fa fa-arrow-circle-left"></i> Back
                </button>
            </div>
            <h2 class="panel-title">Employee Increment SetUp</h2>
        </header>

        <div class="panel-body">

            <!-- Filters Row -->
            <div class="form-row">
                <label class="control-label">Financial Year</label>
                @Html.DropDownListFor(m => m.FinancialYear, Model.YearList,
                    new { @class = "form-control", id = "ddlyear", style = "width:140px; display:inline-block; margin-right:10px;" })

                <label class="control-label">Pay Group</label>
                @Html.DropDownListFor(m => m.PayGroupId, Model.PayGroupList,
                    new { @class = "form-control", id = "ddlpayGroup", style = "width:160px; display:inline-block; margin:0 10px;" })

                <label class="control-label">Employee</label>
                @Html.DropDownListFor(m => m.Empid, Model.masterModel.selectListItems,
                    new { @class = "form-control", id = "EmployeeName", style = "width:180px; display:inline-block; margin:0 10px;" })

                @*<label class="control-label">Rows</label>
            <select class="form-control" onchange="GetSearchbypagenumberResult(1);" id="Pagrow" name="Numberofrow"
                    style="width:70px; display:inline-block;">
                <option selected value="10">10</option>
                <option value="25">25</option>
                <option value="50">50</option>
                <option value="100">100</option>
            </select>*@
            </div>

            <!-- Increment Type -->
            <div class="form-row" style="white-space:nowrap;">
                <label style="margin-right:10px;">Increment Type :</label>
                <label class="radio-inline">
                    <input type="radio" name="IncrementType" id="rdoPercent" value="P" checked> Percentage
                </label>
                <label class="radio-inline">
                    <input type="radio" name="IncrementType" id="rdoAmount" value="A"> Fixed Amount
                </label>
            </div>

            <!-- Pay Components Table -->
            <table class="table table-bordered table-striped table-condensed" style="margin-top:10px;">
                <thead>
                    <tr>
                        <th>Pay Component</th>
                        <th>Increment Value (<span id="lblUnit">%</span>)</th>
                    </tr>
                </thead>
                <tbody id="payConfigBody">
                    <tr><td colspan="2" class="text-center text-muted">Select a Pay Group to load components.</td></tr>
                </tbody>
            </table>

            <!-- Generate Button -->
            <div class="text-center" id="btngenerate" style="margin-top:15px; display:none;">
                <button type="button" id="btnGenerate" class="btn btn-primary btn-sm">
                    <i class="fa fa-cogs"></i> Generate Increment
                </button>
            </div>

            <!-- Pivot Result -->
            <div id="pivotResult" class="panel panel-default" style="display:none; margin-top:20px;">
                <div class="panel-heading"><strong>Increment Preview</strong></div>
                <div class="panel-body" id="pivotContent">
                    <!-- pivot table will load here -->
                </div>
            </div>

            <div class="text-center" id="btnsave" style="margin-top:15px;display:none;">
                <button type="button" id="btnsave" class="btn btn-primary btn-sm">
                    <i class="fa fa-save"></i> Save Increment SetUp
                </button>
            </div>
        </div>
    </section>
</section>

<script src="~/plugins/cdnjs/jquery.twbsPagination.min.js"></script>


<script>
    $(document).ready(function () {

        // Initialize Select2 for dropdowns
        //$("#ddlyear, #ddldepartment, #ddlpayGroup, #EmployeeName").select2();
        $("#ddlyear,  #ddlpayGroup, #EmployeeName").select2();

        // Attach change handler AFTER Select2 initialization
        $(document).on("change", "#ddlpayGroup", function () {
            loadEmployeeDropdown();
            $("#pivotContent").empty();
            $("#pivotResult").hide();
            $("#btngenerate").show();
        });
        // unit label toggle
        $(document).on("change", "input[name='IncrementType']", function () {
            let isPct = $("input[name='IncrementType']:checked").val() === "P";
            $("#lblUnit").text(isPct ? "%" : "₹");
            $(".incrementInput").attr("placeholder", isPct ? "Enter %" : "Enter amount");
        });
        // paygroup change → load pay components
        $(document).on("change", "#ddlpayGroup", loadPayComponents);

    });

    function loadEmployeeDropdown() {
        //var department = $("#ddldepartment option:selected").text();
        var payGroupId = $("#ddlpayGroup").val();

        $.ajax({
            url: '@Url.Action("GetEmployeesByDeptPayGroup", "PayrollTds")',
            type: "POST",
            data: { payGroupId: payGroupId },
            success: function (data) {
                var $emp = $("#EmployeeName");
                $emp.empty();

                if (data && data.length > 0) {
                    $.each(data, function (i, emp) {
                        $emp.append($('<option>', {
                            value: emp.Value,
                            text: emp.Text
                        }));
                    });
                }

                // If using multiselect plugin
                if ($emp.data('multiselect')) {
                    $emp.multiselect('rebuild');
                }
                else {
                    $emp.select2('destroy').select2();
                }
            },
            error: function () {
                alert("Error loading employees");
            }
        });
    }

    function loadPayComponents(){
    let pg=$("#ddlpayGroup").val();
    let body=$("#payConfigBody").empty();
    if(!pg||pg==="0"){body.html("<tr><td colspan='2'>Select a Pay Group.</td></tr>");return;}

    $.ajax({
        url:'@Url.Action("GetPayConfigsByPayGroup","PayrollTds")',
        type:"GET",
        data:{payGroupId:pg},
        success:function(list){
            if(!list||!list.length){body.html("<tr><td colspan='2'>No Pay Components found.</td></tr>");return;}
            let ph=$("input[name='IncrementType']:checked").val()==="P"?"Enter %":"Enter amount";
            $.each(list,function(_,item){
                body.append(`<tr data-id="${item.PayConfigId}">
                    <td class="pc-name text-start">${item.PayConfigName}</td>
                    <td><input type="number" class="form-control form-control-sm incrementInput" placeholder="${ph}"></td>
                </tr>`);
            });
        },
        error:function(){body.html("<tr><td colspan='2'>Failed to load components.</td></tr>");}
    });
    }

    $("#btnGenerate").click(function () {
        $("#btnsave").show();
    var payGroupId = $("#ddlpayGroup").val();
    if (!payGroupId || payGroupId === "0") {
        alert("Please select a Pay Group.");
        return;
    }

    // collect PayComponent increments
    var payConfigs = [];
    $("#payConfigBody tr").each(function () {
        var pcid = $(this).data("id");
        var pcname = $(this).find(".pc-name").text();
        var val = $(this).find("input").val();
        if (val && parseFloat(val) !== 0) {
            payConfigs.push({
                PayConfigId: pcid,
                PayConfigName: pcname,
                IncrementValue: parseFloat(val)
            });
        }
    });

    if (payConfigs.length === 0) {
        alert("Please enter at least one Pay Component increment value.");
        return;
    }

    $.ajax({
        url: '@Url.Action("GenerateIncrementPivot", "PayrollTds")',
        type: "POST",
        contentType: "application/json; charset=utf-8",
        data: JSON.stringify({
            PayGroupId: payGroupId,
            PayConfigs: payConfigs
        }),
        success: function (response) {
            if (response.error) {
                alert(response.error);
                return;
            }

            // Render pivot table
            renderPivotTable(response);
        },
        error: function () {
            alert("Error generating pivot table.");
        }
    });
});

    function renderPivotTable(data) {
        if (!data || data.length === 0) {
            $("#pivotContent").html("<div class='text-center text-muted'>No data found</div>");
            $("#pivotResult").show();
            return;
        }

        let incType = $("input[name='IncrementType']:checked").val();
        let toggleColHeader = incType === "P" ? "Is Fixed Amount?" : "Is Percentage?";

        const columns = Object.keys(data[0]).filter(c => c !== "Select" && c !== "Empno");
        const nonEditableCols = ["EmpCode", "Employee Name"];

        let html = "<table class='table table-bordered table-condensed table-striped'>";
        html += "<thead><tr>";
        html += "<th><input type='checkbox' id='chkAll' /> All</th>";
        columns.forEach(k => html += `<th>${k}</th>`);
        html += `<th>${toggleColHeader}</th>`;
        html += "</tr></thead><tbody>";

        data.forEach((row, i) => {

            html += `<tr data-row="${i}" data-empcode="${row.EmpCode}" data-empno="${row.Empno}">`;

            html += `<td><input type='checkbox' class='chkEmployee' data-empcode='${row.EmpCode}' /></td>`;

            columns.forEach(k => {
                let cell = row[k];

                if (nonEditableCols.includes(k)) {
                    html += `<td>${cell ?? ""}</td>`; // plain text
                } else {
                    let val = cell?.Value ?? "";
                    let id = cell?.Id ?? "";
                    html += `<td contenteditable='true'
                             class='editable'
                             data-col='${k}'
                             data-pcid='${id}'>${val}</td>`;
                }
            });

            html += `<td><input type='checkbox' class='chkFixed' data-empcode='${row.EmpCode}'/></td>`;
            html += "</tr>";
        });

        html += "</tbody></table>";

        $("#pivotContent").empty();
        $("#pivotResult").hide();
        $("#pivotContent").html(html);
        $("#pivotResult").fadeIn(150);

        $("#chkAll").on("change", function () {
            $(".chkEmployee").prop("checked", this.checked);
        });
    }


$(document).on("click", "#btnsave", function () {
    var list = [];

    $("#pivotContent tbody tr").each(function () {
        if (!$(this).find(".chkEmployee").is(":checked")) return;

        var empCode = $(this).data("empcode");
        var empNo = $(this).data("empno");
        var toggleVal = $(this).find(".chkFixed").is(":checked") ? 1 : 2;
        var selectedsession = $("#ddlyear option:selected").text();

        var values = [];

        $(this).find(".editable").each(function () {
            values.push({
                PayComponentId: $(this).data("pcid"),
                IncrementValue: $(this).text().trim()
            });
        });

        list.push({
            session: selectedsession,
            EmpCode: empCode,
            EmpNo: empNo,
            IncrementTypeValue: toggleVal,
            IncrementValues: values
        });
    });

    if (list.length === 0) {
        alert("No employee selected to save.");
        return;
    }

    console.log(list); // check before sending

    $.ajax({
        url: '@Url.Action("SaveIncrement", "PayrollTds")',
        type: "POST",
        contentType: "application/json; charset=utf-8",
        data: JSON.stringify({ Data: list }),
        success: function (res) {
            alert("Saved successfully");
        },
        error: function () {
            alert("Save failed");
        }
    });
});


</script>
