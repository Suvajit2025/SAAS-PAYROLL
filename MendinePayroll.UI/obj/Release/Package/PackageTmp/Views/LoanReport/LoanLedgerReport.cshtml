
@{
    ViewBag.Title = "LoanLedgerReport";
    Layout = "~/Views/Shared/_Layout.cshtml";
}


<style>
    :root {
        --primary: #0E7777;
        --border: #e2e8f0;
        --bg: #f8fafc;
        --text-muted: #64748b;
    }

    .content-body {
        background: #f9fafb;
        padding: 20px;
    }

    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

        .page-header h2 {
            margin: 0;
            font-weight: 700;
            color: #1e293b;
        }

    .filter-card, .table-card {
        background: #fff;
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 16px;
        box-shadow: 0 1px 3px rgba(0,0,0,.08);
        margin-bottom: 20px;
    }

        .filter-card label {
            font-size: 11px;
            font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase;
            margin-bottom: 4px;
        }

    .search-box {
        position: relative;
        max-width: 400px;
    }

        .search-box i {
            position: absolute;
            top: 9px;
            left: 10px;
            color: #94a3b8;
        }

        .search-box input {
            padding-left: 30px;
            border-radius: 6px;
        }

    table {
        border-collapse: separate;
        border-spacing: 0;
    }

    thead th {
        background: var(--bg);
        font-size: 11px;
        text-transform: uppercase;
        border-bottom: 2px solid var(--border);
        position: sticky;
        top: 0;
        z-index: 5;
    }

    tbody tr:nth-child(even) {
        background: #fafafa;
    }

    tbody tr:hover {
        background: #f0fdfa;
    }

    td {
        font-size: 13px;
        vertical-align: middle;
    }

    .col-emp {
        min-width: 220px;
        border-right: 1px solid #e5e7eb;
    }

    .tbl-text {
        font-weight: 600;
        color: #1e293b;
        line-height: 1.2;
    }

    .tbl-text-muted {
        font-size: 11px;
        color: #64748b;
    }

    .td-money {
        text-align: right;
        white-space: nowrap;
        font-variant-numeric: tabular-nums;
    }

    .pagination-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-top: 10px;
    }

    .page-btn {
        padding: 5px 12px;
        border: 1px solid var(--border);
        background: #fff;
        border-radius: 6px;
        margin: 0 2px;
    }

        .page-btn.active {
            background: var(--primary);
            color: #fff;
            border-color: var(--primary);
        }

    .filter-item {
        min-width: 180px;
        display: flex;
        flex-direction: column;
    }

        .filter-item label {
            font-size: 11px;
            font-weight: 600;
            color: #64748b;
            margin-bottom: 4px;
        }

        .filter-item select {
            height: 31px;
            border-radius: 6px;
            border: 1px solid #d1d5db;
            padding: 2px;
        }

    .filter-btn {
        min-width: 120px;
    }
    /* ===== Compact Pagination ===== */
    .pagination-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
        padding-top: 10px;
    }

    .pagination-compact {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
    }

    .page-btn {
        min-width: 34px;
        height: 32px;
        padding: 0 10px;
        border-radius: 6px;
        border: 1px solid #e2e8f0;
        background: #fff;
        font-size: 12px;
        font-weight: 500;
        color: #475569;
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }

        .page-btn:hover:not(.active):not(:disabled) {
            background: #f1f5f9;
        }

        .page-btn.active {
            background: #0E7777;
            border-color: #0E7777;
            color: #fff;
        }

        .page-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

    .page-ellipsis {
        padding: 6px 8px;
        font-size: 12px;
        color: #94a3b8;
    }
    /* ===== Compact Salary Register Table ===== */

    /* Header: small + bold */
    .table thead th {
        font-size: 11px;
        font-weight: 700;
        padding: 8px 10px;
        letter-spacing: .03em;
        white-space: nowrap;
    }

    /* Body cells: compact */
    .table tbody td {
        font-size: 12px;
        padding: 6px 10px;
        line-height: 1.2;
    }

    /* Reduce row height */
    .table tbody tr {
        height: 32px;
    }

    /* Employee column compact */
    .col-emp {
        min-width: 200px;
        padding-right: 12px;
    }

    /* Employee name */
    .tbl-text {
        font-size: 12.5px;
        font-weight: 700;
        color: #1e293b;
        line-height: 1.1;
    }

    /* Employee code */
    .tbl-text-muted {
        font-size: 10.5px;
        color: #64748b;
        line-height: 1;
    }

    /* Numeric salary fields */
    .td-money {
        font-size: 12px;
        font-weight: 600;
        text-align: right;
        white-space: nowrap;
    }

    /* Important totals emphasis */
    .table td[data-total="true"] {
        font-weight: 700;
        color: #0E7777;
    }

    /* Hover stays subtle */
    .table tbody tr:hover {
        background: #f0fdfa;
    }

    /* Reduce table border noise */
    .table td,
    .table th {
        border-top: 1px solid #f1f5f9;
    }
    /* ===== Fixed-size Multiselect with Scroll ===== */
    .multiselect-container {
        max-height: 220px !important;
        overflow-y: auto !important;
    }

    .btn-group > .multiselect {
        height: 32px;
        overflow: hidden;
        white-space: nowrap;
    }

    .multiselect-container > li > a {
        padding: 6px 10px;
        font-size: 12px;
    }

    .multiselect-container label {
        font-weight: 500;
    }


    /*Saikat Mondal 27/01/2026  Start*/
    /* ===================== TABLE GLOBAL CENTERING ===================== */
    .table {
        width: 100%;
    }

        .table th,
        .table td {
            vertical-align: middle !important; /* vertical center */
            text-align: center; /* horizontal center */
            white-space: nowrap;
            padding: 0.75rem;
            font-size: 13px;
        }

    /* ===================== EMPLOYEE COLUMN ===================== */
    .col-emp {
        text-align: center !important;
    }

        .col-emp .tbl-text {
            display: block;
            font-weight: 600;
            line-height: 1.3;
        }

        .col-emp .tbl-text-muted {
            display: block;
            font-size: 12px;
            color: #6c757d;
        }

    /* ===================== MONEY / NUMBER COLUMNS ===================== */
    .td-money {
        text-align: center !important;
        vertical-align: middle !important;
        font-variant-numeric: tabular-nums;
    }

    /* Highlight important numbers */
    .fw-bold.text-primary {
        font-weight: 600 !important;
    }

    /* ===================== ACTION COLUMN ===================== */
    .table td:last-child,
    .table th:last-child {
        text-align: center !important;
        vertical-align: middle !important;
    }

    /* ===================== TEXT TRUNCATION ===================== */
    .text-truncate {
        max-width: 180px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    /* ===================== RESPONSIVE FIX ===================== */
    .table-responsive {
        overflow-x: auto;
    }




    /* --- BADGES (Pills) --- */
    .badge {
        border-radius: 50rem; /* Pill shape */
        padding: 4px 10px;
        font-size: 10px;
        font-weight: 600;
        letter-spacing: 0.3px;
    }

    .badge-processed {
        background-color: #dcfce7;
        color: #166534;
    }

    .badge-paid {
        background-color: #dbeafe;
        color: #1e40af;
    }

    .badge-skipped {
        background-color: #fee2e2;
        color: #991b1b;
    }

    .badge-pending {
        background-color: #fef3c7;
        color: #92400e;
    }

    .badge-upcoming {
        background-color: #f3f4f6;
        color: #4b5563;
    }

    /* --- MODALS --- */
    /*Saikat Mondal 27/01/2026  End*/

</style>

<section class="content-body">

    <!-- HEADER -->
    <header class="page-header">
        <h2 style="font-weight:700; margin:0; color:white;">Salary Structure Report</h2>

    </header>

    <!-- FILTERS -->
    <div class="filter-card">
        <div class="row mb-sm">
            <div class="col-md-6">
                <div class="search-box">
                    <i class="fa fa-search"></i>
                    <input id="searchInput" class="form-control input-sm"
                           placeholder="Search employee, code, department..." />
                </div>
            </div>
            <div class="col-sm-6 text-right">
                <div class="btn-group">
                    @*<button class="btn btn-default btn-sm" onclick="toggleFilterPanel()">
                            <i class="fa fa-filter mr-xs"></i> Filter <span id="filterCount" class="badge">3</span>
                        </button>*@
                    <button class="btn btn-default btn-sm" onclick="exportExcel()">
                        <i class="fa fa-file-excel-o mr-xs" style="color:#16a34a;"></i> Export
                    </button>
                    <button class="btn btn-default btn-sm" onclick="refreshGrid()">
                        <i class="fa fa-refresh"></i>
                    </button>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-2 filter-item">
                <label>Company</label>
                <select id="ddlCompany" class="form-control multi-select" multiple></select>
            </div>
            <div class="col-md-2 filter-item">
                <label>Department</label>
                <select id="ddlDepartment" class="form-control multi-select" multiple></select>
            </div>
            @*<div class="col-md-2 filter-item">
                    <label>Pay Group</label>
                    <select id="ddlpaygroup" class="form-control multi-select" multiple></select>
                </div>*@
            <div class="col-md-2 filter-item">
                <label>Employee</label>
                <select id="ddlEmployee" class="form-control multi-select" multiple></select>
            </div>
            <div class="col-md-2 filter-btn">
                <label>&nbsp;</label>
                <button id="btnClearFilters" class="btn btn-default btn-block btn-sm">
                    Reset
                </button>
            </div>
        </div>
    </div>

    <!-- TABLE -->
    <div class="table-card">
        <div class="table-responsive">
            <table class="table table-hover mb-none text-center align-middle">
                <thead id="ctcHead"></thead>
                <tbody id="gridBody">
                    <tr><td colspan="20" class="text-center">Loading...</td></tr>
                </tbody>
            </table>
        </div>

        <div class="pagination-bar">
            <div id="paginationInfo" class="text-muted small"></div>
            <div id="paginationControls"></div>
        </div>
    </div>

</section>
@*Modal Popap Loan Ladger Report start*@
    <div class="modal fade" id="loanLedgerModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg modal-xl-custom" role="document">
        <div class="modal-content">
            <header class="panel-heading" style="background: linear-gradient(135deg, #1e293b, #334155) !important; padding: 15px 20px;">

                <div class="pull-right">
                    <button id="btnExportLedger" class="btn btn-success btn-sm mr-sm" style="border:none;">
                        <i class="fa fa-file-excel-o"></i> Excel
                    </button>
                    <button type="button" class="close" style="color:white; opacity:0.8; text-shadow:none;" data-dismiss="modal">&times;</button>
                </div>

                <h2 class="panel-title" style="color: white !important; font-size: 18px; font-weight: 600;">
                    <i class="fa fa-list-alt mr-sm"></i>Loan Ledger
                </h2>

                <p class="panel-subtitle" id="ledgerLoanInfo" style="color: #cbd5e1 !important; font-size: 13px; margin-top: 5px; margin-bottom: 0;">
                    Transaction history
                </p>
            </header>

            <div class="modal-body" style="background:#f9fafb; padding:0; max-height: 70vh; overflow-y: auto;">
                <table class="table table-striped mb-none" id="ledgerTable" style="border:none;">
                    <thead style="position:sticky; top:0; z-index:10; box-shadow:0 1px 2px rgba(0,0,0,0.05); background:#fff;">
                        <tr>
                            <th>#</th>
                            <th>Month</th>
                            <th class="text-right">Principal</th>
                            <th class="text-right">Interest</th>
                            <th class="text-right">Total Due</th>
                            <th class="text-right">Bal Before</th>
                            <th class="text-right">Bal After</th>
                            <th class="text-right">Paid</th>
                            <th class="text-right">Source</th>
                            <th class="text-center">Status</th>
                        </tr>
                    </thead>
                    <tbody id="loanLedgerBody" style="background:white;"></tbody>
                </table>
            </div>
            <div class="modal-footer">
                <button class="btn btn-default" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
@*Modal Popap Loan Ladger Report end*@


<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
    let ctcData = [], filteredData = [], ctcColumns = [];
    let currentPage = 1, pageSize = 10;

    // IDs hidden from UI & Excel
    const hiddenColumns = [
        "EmployeeID", "CompanyId", "DepartmentId",
        "PayGroupID", "EmpNo", "EmpCode", "EmpName", "empid", "IDLoan","DepartmentID"
    ];

    $(function () {
        initMultiSelects();
        loadFilters();
        loadCTCReport();

        $('#searchInput').on('keyup', applyFilters);
        $('.multi-select').on('change', applyFilters);
        $('#btnClearFilters').click(clearFilters);
    });

    function initMultiSelects() {
        $('.multi-select').multiselect({
            includeSelectAllOption: true,
            enableFiltering: true,
            enableCaseInsensitiveFiltering: true,
            maxHeight: 220,              // 🔑 fixed height
            buttonWidth: '100%',
            nonSelectedText: 'All',
            numberDisplayed: 1,
            buttonClass: 'btn btn-default btn-sm'
        });
    }


    function loadFilters() {
        loadDropdown('/SalaryCTC/GetCompanyList', '#ddlCompany', 'CompanyId', 'CompanyName');
        loadDropdown('/SalaryCTC/GetDepartmentList', '#ddlDepartment', 'DepartmentID', 'DepartmentName');
     
        loadEmployeeByFilters();
    }

    function loadDropdown(url, ddl, id, text) {
        $.getJSON(url, res => {
            const $ddl = $(ddl).empty();
            res.forEach(x => $ddl.append(`<option value="${x[id]}">${x[text]}</option>`));
            $ddl.multiselect('rebuild');
        });
    }
    function loadEmployeeByFilters() {

        const companyIds = $('#ddlCompany').val() || [];
        const deptIds = $('#ddlDepartment').val() || [];
        const categoryIds = 1;

        $.ajax({
            url: '/SalaryCTC/GetEmployeeList',
            type: 'GET',
            traditional: true,
            data: {
                companyIds: companyIds,
                deptIds: deptIds,
                categoryIds: categoryIds
            },
            success: function (res) {

                const $ddl = $('#ddlEmployee');
                $ddl.empty();

                //  Show only ACTIVE employees
                const activeEmployees = res.filter(x => x.Empstatus === 'ACTIVE');

                activeEmployees.forEach(x => {
                    $ddl.append(`
                    <option value="${x.EmpID}">
                        ${x.EmpName} (${x.EmpCode})
                    </option>
                `);
                });

                $ddl.multiselect('rebuild');
            }
        });
    }


    function loadCTCReport() {
        $.getJSON('/LoanReport/GetLoanLedgerReport', res => {
            ctcColumns = res.columns.filter(c => !hiddenColumns.includes(c));
            ctcColumns.unshift('Employee');
            

            ctcData = res.rows;
            filteredData = [...ctcData];
            buildHeader();
            paginate();
        });
    }

    function buildHeader() {
        let h = '<tr>';
        ctcColumns.forEach(c => {
            console.log(c);
            if (c === 'DepartmentName') {
                h += `<th class="${c === 'EmpName' ? 'col-emp' : ''}">Department Name</th>`;
            } else if (c === 'CompanyName') {
                h += `<th class="${c === 'EmpName' ? 'col-emp' : ''}">Company Name</th>`;
            } else if (c === 'LoanType') {
                h += `<th class="${c === 'EmpName' ? 'col-emp' : ''}">Loan Type</th>`;
            } else if (c === 'SanctionedAmount') {
                h += `<th class="${c === 'EmpName' ? 'col-emp' : ''}">Sanctioned Amount</th>`;
            } else if (c === 'TotalCreditAmount') {
                h += `<th class="${c === 'EmpName' ? 'col-emp' : ''}">Total Credit Amount</th>`;
            } else if (c === 'RunningBalance') {
                h += `<th class="${c === 'EmpName' ? 'col-emp' : ''}">Running Balance</th>`;
            } else if (c === 'LoanStatus') {
                h += `<th class="${c === 'EmpName' ? 'col-emp' : ''}">Loan Status</th>`;
            } else if (c === 'LoanDate') {
                h += `<th class="${c === 'EmpName' ? 'col-emp' : ''}">Loan Date</th>`;
            } else if (c === 'RepaymentStartMonthYear') {
                h += `<th class="${c === 'EmpName' ? 'col-emp' : ''}">Repayment Start Month Year</th>`;
            } else { 
                h += `<th class="${c === 'EmpName' ? 'col-emp' : ''}">${c}</th>`;
            }
          
        });

        h += `<th class="text-right">Action</th>`;
        h += '</tr>';
        $('#ctcHead').html(h);
    }

    function paginate() {
        const start = (currentPage - 1) * pageSize;
        renderRows(filteredData.slice(start, start + pageSize));
        renderPagination(filteredData.length);
    }
    function jsSafe(v) { return (v || "").replace(/'/g, "\\'").replace(/"/g, '\\"'); }
    function renderRows(rows) {
        const $b = $('#gridBody').empty();

        if (!rows.length) {
            $b.html(`
            <tr>
                <td colspan="${ctcColumns.length}" class="text-center text-muted">
                    No records found
                </td>
            </tr>
        `);
            return;
        }

        rows.forEach(r => {
            let tr = '<tr>';

            ctcColumns.forEach(c => {

                /* ================= EMPLOYEE COLUMN ================= */
                if (c === 'Employee') {
                    tr += `
                    <td class="col-emp">
                        <span class="tbl-text">${escapeHtml(r['EmpName'])}</span>
                        <span class="tbl-text-muted">(${escapeHtml(r.EmpCode)})</span>

                    </td>`;
                    return;
                }

                let v = r[c];

                /* ================= NUMERIC COLUMNS ================= */
                if (typeof v === 'number') {

                    const isImportant =
                        c === 'NET PAY' ||
                        c === 'MONTHLY CTC' ||
                        c === 'YEARLY CTC';

                    tr += `
                    <td class="td-money ${isImportant ? 'fw-bold text-primary' : ''}">
                        ${v.toLocaleString('en-IN', {
                        minimumFractionDigits: 2,
                        maximumFractionDigits: 2
                    })}
                    </td>`;
                }
                /* ================= TEXT COLUMNS ================= */
                else {
                    tr += `
                    <td class="text-truncate">
                        ${escapeHtml(v)}
                    </td>`;
                }
            });

            tr += `
                <td class="text-right">
                    <button class="btn btn-smS"
                        title="Show Reoprt"
                        onclick="viewLoan(${r.IDLoan},'${r.LoanNo}','${jsSafe(r.EmpName)}')">
                        <i class="fa fa-list-alt"></i>
                    </button>
                </td>`;
            //viewLoan(${l.id},'${l.no}','${jsSafe(l.emp)}')

            tr += '</tr>';
            $b.append(tr);
        });
    }


    function applyFilters() {
        const s = $('#searchInput').val().toLowerCase();
        const comp = $('#ddlCompany').val() || [];
        const dept = $('#ddlDepartment').val() || [];
        //const pg = $('#ddlpaygroup').val() || [];
        const emp = $('#ddlEmployee').val() || [];

        filteredData = ctcData.filter(r =>
            (!s || `${r['Employee Name']} ${r.EmpCode} ${r.Department}`.toLowerCase().includes(s)) &&
            (!comp.length || comp.includes(r.CompanyId?.toString())) &&
            (!dept.length || dept.includes(r.DepartmentID?.toString())) &&
            // (!pg.length || pg.includes(r.PayGroupID?.toString())) &&
            (!emp.length || emp.includes(r.empid?.toString()))
        );

        currentPage = 1;
        paginate();
    }

    function renderPagination(totalItems) {

        const totalPages = Math.ceil(totalItems / pageSize);
        if (totalPages <= 1) {
            $('#paginationControls').empty();
            $('#paginationInfo').html(`Showing ${totalItems} entries`);
            return;
        }

        const maxVisible = 5; // how many page numbers to show
        let start = Math.max(1, currentPage - 2);
        let end = Math.min(totalPages, start + maxVisible - 1);

        if (end - start < maxVisible - 1) {
            start = Math.max(1, end - maxVisible + 1);
        }

        let html = `<div class="pagination-compact">`;

        // Prev
        html += `
        <button class="page-btn"
            ${currentPage === 1 ? 'disabled' : ''}
            onclick="changePage(${currentPage - 1})">
            ‹
        </button>`;

        // First page
        if (start > 1) {
            html += `<button class="page-btn" onclick="changePage(1)">1</button>`;
            if (start > 2) html += `<span class="page-ellipsis">…</span>`;
        }

        // Page window
        for (let i = start; i <= end; i++) {
            html += `
            <button class="page-btn ${i === currentPage ? 'active' : ''}"
                onclick="changePage(${i})">${i}</button>`;
        }

        // Last page
        if (end < totalPages) {
            if (end < totalPages - 1) html += `<span class="page-ellipsis">…</span>`;
            html += `<button class="page-btn" onclick="changePage(${totalPages})">${totalPages}</button>`;
        }

        // Next
        html += `
        <button class="page-btn"
            ${currentPage === totalPages ? 'disabled' : ''}
            onclick="changePage(${currentPage + 1})">
            ›
        </button>`;

        html += `</div>`;

        $('#paginationControls').html(html);

        const startIdx = (currentPage - 1) * pageSize + 1;
        const endIdx = Math.min(currentPage * pageSize, totalItems);

        $('#paginationInfo').html(
            `Showing <b>${startIdx}</b> to <b>${endIdx}</b> of <b>${totalItems}</b> entries`
        );
    }


    function changePage(p) { currentPage = p; paginate(); }

    function clearFilters() {
        $('.multi-select').multiselect('deselectAll', false).multiselect('updateButtonText');
        $('#searchInput').val('');
        filteredData = [...ctcData];
        currentPage = 1;
        paginate();
    }

    function exportExcel() {
        const out = filteredData.map(r => {
            let o = {};
            ctcColumns.forEach(c => {
                if (c === 'EmpName')
                    o.Employee = `${r['EmpName']} (${r.EmpNo})`;
                else
                    o[c] = r[c];
            });
            return o;
        });

        const ws = XLSX.utils.json_to_sheet(out);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Loan Ledger Report");
        XLSX.writeFile(wb, "Loan_Ledger_Report.xlsx");
    }

    function escapeHtml(t) {
        return t ? t.toString().replace(/[&<>"']/g, m =>
            ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' }[m])) : '';
    }


    function viewLoan(loanId, loanNo, empName) {

        // Show Loan Title + Employee in the header
        $("#ledgerLoanInfo").html(
            `Loan No: <b>${loanNo}</b> &nbsp; | &nbsp; Employee: <b>${empName}</b>`
        );
        // ---------------------------------------------------------
        // 2. DYNAMICALLY UPDATE EXPORT BUTTON PARAMETERS
        // ---------------------------------------------------------
        // We use .attr() to rewrite the onclick with the specific LoanNo and Name
        // We use jsSafe() to handle names with quotes (e.g., O'Connor)
        $("#btnExportLedger").attr("onclick", `exportLedgerToExcel('${loanNo}', '${jsSafe(empName)}')`);

        $.get("/Loan/ViewLoanSchedule?loanId=" + loanId, function (data) {

            let body = "";
            data.forEach(row => {

                // Map status to your new CSS badge classes
                let badgeClass = {
                    "Processed": "badge-processed",
                    "Paid": "badge-paid",
                    "Skipped": "badge-skipped",
                    "Pending": "badge-pending",
                    "Upcoming": "badge-upcoming"
                }[row.Status] || "badge-upcoming";

                // Build the table row
                body += `
         <tr>
             <td>${row.EMI_No}</td>
             <td>${row.MonthName} ${row.YearNo}</td>
             <td class="text-right">${row.PrincipalDue.toFixed(2)}</td>
             <td class="text-right">${row.InterestDue.toFixed(2)}</td>
             <td class="text-right text-weight-bold">${row.TotalDue.toFixed(2)}</td>

             <td class="text-right text-muted">${row.BalanceBefore.toFixed(2)}</td>
             <td class="text-right text-muted">${row.BalanceAfter.toFixed(2)}</td>

             <td class="text-right text-primary" style="font-weight:bold;">${(row.AmountPaid ?? 0).toFixed(2)}</td>
             <td class="text-right">${row.ProcessSource || '-'}</td>
             <td class="text-center"><span class="badge ${badgeClass}">${row.Status}</span></td>
         </tr>
         `;
            });

            // Inject HTML
            $("#loanLedgerBody").html(body);

            //  CORRECT WAY to open Bootstrap Modal
            $("#loanLedgerModal").modal('show');
        });
    }


    function exportLedgerToExcel(loanNo, empName) {
        // 1. Select the table element
        var table = document.getElementById("ledgerTable");
        if (!table) {
            toastr.error("Table data not found.");
            return;
        }

        // 2. Create a Workbook Object from the Table
        // 'sheet: "Ledger"' names the tab inside Excel
        var wb = XLSX.utils.table_to_book(table, { sheet: "Ledger" });

        // 3. Clean strings for filename (remove special chars)
        var safeLoanNo = (loanNo || "Loan").replace(/[^a-zA-Z0-9-_]/g, "");
        var safeEmpName = (empName || "Employee").replace(/[^a-zA-Z0-9-_ ]/g, "").trim();

        // 4. Create Filename: Loan_L101_JohnDoe.xlsx
        var filename = `Loan_${safeLoanNo}_${safeEmpName}.xlsx`;

        // 5. Trigger Download
        XLSX.writeFile(wb, filename);
    }


</script>
