@{
    ViewBag.Title = "Salary Register";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

<style>
    /* FULL SCREEN LOCK */
    .payroll-loader {
        position: fixed;
        inset: 0;
        z-index: 10000;
        display: none;
    }

    .payroll-backdrop {
        position: absolute;
        inset: 0;
        background: rgba(15, 23, 42, 0.65);
        pointer-events: all;
    }

    .payroll-box {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: #ffffff;
        padding: 28px 38px;
        border-radius: 14px;
        text-align: center;
        box-shadow: 0 18px 40px rgba(0,0,0,.35);
    }

        .payroll-box i {
            font-size: 44px;
            color: #0E7777;
            margin-bottom: 12px;
        }

    .payroll-text {
        font-size: 14px;
        font-weight: 600;
        color: #334155;
    }

    /* PAGINATION STYLES */
    .pagination-compact {
        display: inline-flex;
        gap: 4px;
    }

    .page-btn {
        min-width: 32px;
        height: 30px;
        padding: 0 10px;
        border-radius: 4px;
        border: 1px solid #e2e8f0;
        background: #fff;
        font-size: 12px;
        font-weight: 600;
        color: #475569;
        transition: all 0.2s;
    }

        .page-btn:hover:not(.active):not(:disabled) {
            background: #f1f5f9;
            border-color: #cbd5e1;
        }

        .page-btn.active {
            background: #0E7777;
            border-color: #0E7777;
            color: #fff;
        }

        .page-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

    .page-ellipsis {
        padding: 4px 8px;
        font-size: 12px;
        color: #94a3b8;
    }
</style>

<section role="main" class="content-body">
    <header class="page-header">
        <h2 style="font-weight:700; margin:0;">Salary Register</h2>
    </header>

    <section class="panel">
        <header class="panel-heading" style="display:flex; justify-content:space-between; align-items:center;">
            <div style="display:flex; align-items:center;">
                <button type="button" class="btn btn-default btn-sm" onclick="window.history.back();" style="margin-right: 15px;">
                    <i class="fa fa-arrow-left text-muted"></i> Back
                </button>
                <h2 class="panel-title" style="margin:0; line-height:1;">
                    <i class="fa fa-money text-primary mr-sm"></i> Employee Salary Processing
                </h2>
            </div>

            <div class="btn-group">
                <button onclick="approveSelectedSalaries()" class="btn btn-primary btn-sm"><i class="fa fa-check-circle mr-xs"></i> Approve / Finalize</button>
                <button onclick="rejectSelectedSalaries()" class="btn btn-danger btn-sm"><i class="fa fa-times-circle mr-xs"></i> Reject</button>
                <button onclick="downloadBulkPayslips()" class="btn btn-default btn-sm"><i class="fa fa-file-pdf-o text-danger mr-xs"></i> Bulk Payslips</button>
                <button onclick="processPayment()" class="btn btn-success btn-sm"><i class="fa fa-check-circle mr-xs"></i> Mark as Paid</button>
            </div>
        </header>

        <div class="panel-body">
            <div class="row mb-md">
                <div class="col-sm-4">
                    <div class="input-group">
                        <span class="input-group-addon" style="background:#fff; border-right:none;"><i class="fa fa-search text-muted"></i></span>
                        <input type="text" id="searchInput" class="form-control" style="border-left:none;" placeholder="Search Name or Emp Code..." onkeyup="applyFilters()">
                    </div>
                </div>
                <div class="col-sm-8 text-right">
                    <div class="btn-group">
                        <button class="btn btn-default btn-sm" onclick="toggleFilterPanel()"><i class="fa fa-filter mr-xs"></i> Filter <span id="filterCount" class="badge">3</span></button>
                        <button class="btn btn-default btn-sm" onclick="exportExcel()"><i class="fa fa-file-excel-o mr-xs" style="color:#16a34a;"></i> Export</button>
                        <button class="btn btn-default btn-sm" onclick="refreshGrid()"><i class="fa fa-refresh"></i></button>
                    </div>
                </div>
            </div>

            <div id="filterPanel" style="display:block; background:#f8fafc; border:1px solid #e2e8f0; border-radius:6px; padding:15px; margin-bottom:15px;">
                <div class="row">
                    <div class="col-md-2">
                        <label class="control-label text-xs text-muted text-weight-bold">Month</label>
                        <select id="fltMonth" class="form-control input-sm"></select>
                    </div>
                    <div class="col-md-2">
                        <label class="control-label text-xs text-muted text-weight-bold">Year</label>
                        <select id="fltYear" class="form-control input-sm"></select>
                    </div>
                    <div class="col-md-3">
                        <label class="control-label text-xs text-muted text-weight-bold">Company</label>
                        <select id="fltCompany" class="form-control input-sm"><option value="">All Companies</option></select>
                    </div>
                    <div class="col-md-3">
                        <label class="control-label text-xs text-muted text-weight-bold">Pay Group</label>
                        <select id="fltPayGroup" class="form-control input-sm"><option value="">All Groups</option></select>
                    </div>
                    <div class="col-md-2">
                        <label class="control-label text-xs text-muted text-weight-bold">Process Status</label>
                        <select id="fltStatus" class="form-control input-sm">
                            <option value="">All</option>
                            <option value="1">Draft</option>
                            <option value="2" selected>Finalized</option>
                        </select>
                    </div>

                </div>
                <div class="row mt-sm">
                    <div class="col-md-12 text-right">
                        <button type="button" class="btn btn-xs btn-warning" id="btnClearFilters">
                            <i class="fa fa-refresh"></i> Clear All Filters
                        </button>
                    </div>
                </div>
            </div>

            <div class="table-responsive">
                <table class="table table-striped table-hover mb-none">
                    <thead>
                        <tr>
                            <th style="width:30px;"><input type="checkbox" id="chkAll"></th>
                            <th style="width:80px;">Emp Info</th>
                            <th style="width:150px;">Company & Group</th>
                            <th class="text-right">Basic</th>
                            <th class="text-right">Allowances</th>
                            <th class="text-right">Gross</th>
                            <th class="text-right text-danger">Deduction</th>
                            <th class="text-right text-primary">Net Pay</th>
                            <th class="text-center" style="width:40px;">Salary Process</th>
                            <th class="text-center" style="width:40px;">Pay Status</th>
                            <th class="text-center">Action</th>
                        </tr>
                    </thead>
                    <tbody id="gridBody"></tbody>
                </table>
            </div>

            <div class="row mt-lg" style="align-items:center;">
                <div class="col-sm-6">
                    <div style="display:flex; align-items:center; gap:15px;">
                        <div class="input-group" style="width:130px;">
                            <span class="input-group-addon" style="font-size:11px; font-weight:700;">Rows</span>
                            <select id="ddlPageSize" class="form-control input-sm" onchange="changePageSize()">
                                <option value="10">10</option>
                                <option value="25">25</option>
                                <option value="50" selected>50</option>
                                <option value="100">100</option>
                            </select>
                        </div>
                        <div id="paginationInfo" class="text-muted text-xs" style="font-weight:500;"></div>
                    </div>
                </div>
                <div class="col-sm-6 text-right">
                    <div id="paginationControls"></div>
                </div>
            </div>
        </div>
    </section>
</section>

<div class="modal fade" id="BankModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header bg-primary" style="padding: 15px;">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true" style="color:white;">&times;</span></button>
                <h4 class="modal-title" style="color:white; margin:0;"><i class="fa fa-university mr-xs"></i>Bank Details</h4>
            </div>
            <div class="modal-body" style="background:#fdfdfd;">
                <div class="row mb-sm" style="border-bottom:1px solid #eee; padding-bottom:5px;">
                    <div class="col-xs-5 text-muted text-weight-bold">Employee Name</div>
                    <div class="col-xs-7 text-primary text-weight-semibold" id="lblModalName">--</div>
                </div>
                <div class="row mb-sm" style="border-bottom:1px solid #eee; padding-bottom:5px;">
                    <div class="col-xs-5 text-muted text-weight-bold">Bank Name</div>
                    <div class="col-xs-7 text-dark" id="lblModalBank">--</div>
                </div>
                <div class="row mb-sm" style="border-bottom:1px solid #eee; padding-bottom:5px;">
                    <div class="col-xs-5 text-muted text-weight-bold">Branch</div>
                    <div class="col-xs-7 text-dark" id="lblModalBranch">--</div>
                </div>
                <div class="row mb-sm" style="border-bottom:1px solid #eee; padding-bottom:5px;">
                    <div class="col-xs-5 text-muted text-weight-bold">IFSC Code</div>
                    <div class="col-xs-7 text-dark" style="font-family:monospace;" id="lblModalIfsc">--</div>
                </div>
                <div class="row">
                    <div class="col-xs-5 text-muted text-weight-bold">Account No</div>
                    <div class="col-xs-7 text-success text-weight-bold" style="font-size:1.1em; font-family:monospace;" id="lblModalAcct">--</div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="MarkPaidModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document" style="max-width:420px;">
        <div class="modal-content">
            <div class="modal-header bg-success" style="padding: 15px;">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true" style="color:white;">&times;</span>
                </button>
                <h4 class="modal-title" style="color:white; margin:0;">
                    <i class="fa fa-check-circle mr-xs"></i> Mark Salary as Paid
                </h4>
            </div>

            <div class="modal-body">
                <div class="alert alert-info" style="margin-bottom:10px;">
                    Selected Employees: <b id="lblSelectedCount">0</b>
                </div>

                <div class="form-group">
                    <label class="control-label">Paid Date</label>
                    <input type="date" class="form-control" id="txtPaidDate">
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn btn-default" data-dismiss="modal">Cancel</button>
                <button class="btn btn-success" id="btnConfirmPaid">
                    <i class="fa fa-check"></i> Paid
                </button>
            </div>
        </div>
    </div>
</div>
<!-- Skipped Employees Modal -->
<div class="modal fade" id="SkippedEmployeeModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-md" role="document">
        <div class="modal-content">

            <div class="modal-header bg-warning" style="padding:15px;">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true" style="color:white;">&times;</span>
                </button>
                <h4 class="modal-title" style="color:white; margin:0;">
                    <i class="fa fa-exclamation-triangle mr-xs"></i> Skipped Employees
                </h4>
            </div>

            <div class="modal-body" style="background:#fdfdfd;">
                <!-- JS will inject table here -->
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">
                    Close
                </button>
            </div>

        </div>
    </div>
</div>

<!-- Payroll Processing Loader -->
<div id="payrollLoader" class="payroll-loader">
    <div class="payroll-backdrop"></div>
    <div class="payroll-box">
        <i class="fas fa-cogs fa-spin"></i>
        <div class="payroll-text">Finalize Salary…</div>
    </div>
</div>
<link href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" rel="stylesheet" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
@*<script>
    let pageNumber = 1;
    let pageSize = 50;
    let selectedPayrollEmployeeIds = []; // Global memory for checkbox selection

    $(document).ready(function () {
        $("#fltStatus").val("");
        pageSize = parseInt($("#ddlPageSize").val() || "50");
        loadFilterData();
    });
    /* Attach events via jQuery (recommended instead of inline onchange) */
    $(document).on("change", "#fltMonth,#fltYear,#fltCompany,#fltPayGroup,#fltStatus", function () {
        applyFilters();
    });

    //$(document).on("click", "#btnApplyFilters", function () {
    //    applyFilters();
    //});

    $(document).on("click", "#btnClearFilters", function () {
        clearFilters();
    });
    function loadFilterData() {
        bindMonthYear(); // Sync call
        $.ajax({
            url: "/PayrollSalaryReport/GetFilterData",
            type: "GET",
            success: function (res) {
                if (res && res.success) {
                    const companies = [{ Value: "", Text: "All Companies" }].concat(res.companies || []);
                    bindSelect("#fltCompany", companies, "");
                    const payGroups = [{ Value: "", Text: "All Groups" }].concat(res.payGroups || []);
                    bindSelect("#fltPayGroup", payGroups, "");
                }
                refreshGrid(); // Trigger first hit here
            },
            error: function () { refreshGrid(); }
        });
    }

    //function applyFilters() {
    //    pageNumber = 1;
    //    resetGlobalSelection(); // Selection should clear when filters change
    //    refreshGrid();
    //}
    function applyFilters() {
        pageNumber = 1;
        // 🔑 Reset selection memory ONLY when filters change
        if (typeof resetGlobalSelection === "function") {
            resetGlobalSelection();
        }
        refreshGrid();
    }
    function changePageSize() {
        pageSize = parseInt($("#ddlPageSize").val());
        pageNumber = 1;
        refreshGrid();
    }

    function changePage(p) {
        pageNumber = p;
        refreshGrid();
    } 
    //function refreshGrid() {
    //    const month = parseInt($("#fltMonth").val() || "0", 10);
    //    const year = parseInt($("#fltYear").val() || "0", 10);
    //    pageSize = parseInt($("#ddlPageSize").val() || "50");

    //    // 🔑 1. Reset "Select All" checkbox and selection memory on every refresh
    //    $("#chkAll").prop("checked", false);
    //    if (typeof resetGlobalSelection === "function") {
    //        resetGlobalSelection(); // This clears your internal ID array/memory
    //    }

    //    if (!month || !year) {
    //        $("#gridBody").html('<tr><td colspan="11" class="text-center p-lg text-muted">Select Month and Year.</td></tr>');
    //        return;
    //    }

    //    $("#gridBody").html('<tr><td colspan="11" class="text-center p-lg text-muted"><i class="fa fa-spinner fa-spin"></i> Loading...</td></tr>');

    //    $.ajax({
    //        url: "/PayrollSalaryReport/GetGrid",
    //        type: "GET",
    //        data: {
    //            month: month, year: year,
    //            companyId: $("#fltCompany").val() || null,
    //            payGroupId: $("#fltPayGroup").val() || null,
    //            search: ($("#searchInput").val() || "").trim(),
    //            status: $("#fltStatus").val() || null,
    //            pageNumber: pageNumber, pageSize: pageSize
    //        },
    //        success: function (res) {
    //            if (!res || !res.success || !res.rows.length) {
    //                $("#gridBody").html('<tr><td colspan="11" class="text-center p-lg text-muted">No records found.</td></tr>');
    //                $("#paginationInfo").text("");
    //                $("#paginationControls").empty();
    //                return;
    //            }

    //            renderSalaryRegisterGrid(res.rows);

    //            const total = Number(res.totalRows || 0);
    //            const from = ((pageNumber - 1) * pageSize + 1);
    //            const to = Math.min(pageNumber * pageSize, total);
    //            $("#paginationInfo").html(`Showing <b>${from}</b> to <b>${to}</b> of <b>${total}</b> entries`);
    //            renderPaginationButtons(total);
    //        }
    //    });
    //}
    function refreshGrid() {
        const month = parseInt($("#fltMonth").val() || "0", 10);
        const year = parseInt($("#fltYear").val() || "0", 10);
        pageSize = parseInt($("#ddlPageSize").val() || "50");

        // ❌ REMOVED: resetGlobalSelection(); 
        // We don't want to clear memory when moving between pages.

        // 🔑 Just uncheck the visual "Select All" box for the new page.
        // The renderSalaryRegisterGrid function will handle checking individual rows from memory.
        $("#chkAll").prop("checked", false);

        if (!month || !year) {
            $("#gridBody").html('<tr><td colspan="11" class="text-center p-lg text-muted">Select Month and Year.</td></tr>');
            return;
        }

        $("#gridBody").html('<tr><td colspan="11" class="text-center p-lg text-muted"><i class="fa fa-spinner fa-spin"></i> Loading...</td></tr>');

        $.ajax({
            url: "/PayrollSalaryReport/GetGrid",
            type: "GET",
            data: {
                month: month, year: year,
                companyId: $("#fltCompany").val() || null,
                payGroupId: $("#fltPayGroup").val() || null,
                search: ($("#searchInput").val() || "").trim(),
                status: $("#fltStatus").val() || null,
                pageNumber: pageNumber, pageSize: pageSize
            },
            success: function (res) {
                if (!res || !res.success || !res.rows.length) {
                    $("#gridBody").html('<tr><td colspan="11" class="text-center p-lg text-muted">No records found.</td></tr>');
                    $("#paginationInfo").text("");
                    $("#paginationControls").empty();
                    return;
                }

                renderSalaryRegisterGrid(res.rows);

                const total = Number(res.totalRows || 0);
                const from = ((pageNumber - 1) * pageSize + 1);
                const to = Math.min(pageNumber * pageSize, total);
                $("#paginationInfo").html(`Showing <b>${from}</b> to <b>${to}</b> of <b>${total}</b> entries`);
                renderPaginationButtons(total);
            }
        });
    }
    function renderSalaryRegisterGrid(rows) {
        const $tbody = $("#gridBody").empty();

        rows.forEach(function (r) {
            const id = String(r.PayrollProcessEmployeeID);
            const isChecked = selectedPayrollEmployeeIds.includes(id) ? "checked" : "";

            // 🔑 1. Dynamic Status Badge (Draft, Finalize, or Rejected)
            let statusBadge = '';
            if (r.Status == 2) {
                statusBadge = '<span class="label label-success">' +
                    '<i class="fa fa-check-circle"></i> Finalized' +
                    '</span>';
            } else if (r.Status == 3) {
                statusBadge = '<span class="label label-danger animated pulse">' +
                    '<i class="fa fa-undo"></i>  Rejected' +
                    '</span>';
            } else {
                statusBadge = '<span class="label label-warning">' +
                    '<i class="fa fa-pencil"></i> Draft' +
                    '</span>';
            }
            
            // 🔑 2. Payslip Button Logic (Disable if Status is 1 or 3)
            // Only Finalized (Status 2) employees get a payslip.
            const isPayslipDisabled = (r.Status == 1 || r.Status == 3) ? "disabled" : "";
            const payslipBtnClass = (r.Status == 1 || r.Status == 3) ? "btn-default opacity-50" : "btn-primary";
            const payslipTitle = (r.Status == 1 || r.Status == 3) ? "Payslip unavailable for Draft/Rejected" : "Download Payslip";

            const tr = `
        <tr class="${r.Status == 3 ? 'bg-danger-light' : ''}">
            <td><input type="checkbox" class="row-check" value="${id}" ${isChecked}></td>
            <td>
                <div style="font-weight:600; color:#333;">${escapeHtml(r.EmployeeName)}</div>
                <div class="text-xs text-muted">${escapeHtml(r.EmployeeCode)}</div>
            </td>
            <td>
                <div class="text-sm">${escapeHtml(r.CompanyName)}</div>
                <div class="text-xs text-muted">${escapeHtml(r.PayGroupName)}</div>
            </td>
            <td class="text-right">${Number(r.BasicAmount || 0).toLocaleString('en-IN')}</td>
            <td class="text-right">${Number(r.AllowancesAmount || 0).toLocaleString('en-IN')}</td>
            <td class="text-right text-weight-bold">${Number(r.TotalGross || 0).toLocaleString('en-IN')}</td>
            <td class="text-right text-danger">${Number(r.TotalDeduction || 0).toLocaleString('en-IN')}</td>
            <td class="text-right text-primary text-weight-bold" style="background:#f9f9f9">
                ${Number(r.TotalTakeHome || 0).toLocaleString('en-IN')}
            </td>
            <td class="text-center">${statusBadge}</td>
            <td class="text-center">
                ${r.PaidStatus == 1
                                ? '<span class="label label-success">' +
                                '<i class="fa fa-check-circle"></i> Paid' +
                                '</span>'
                                : '<span class="label label-warning">' +
                                '<i class="fa fa-hourglass-half"></i> Pending' +
                                '</span>'
                }
            </td>

            <td class="text-center">
                <div style="display: flex; justify-content: center; gap: 5px;">
                    <button class="btn btn-xs btn-default"
                            onclick="openBankModal(${r.EmployeeID}, '${escapeHtml(r.EmployeeName)}')" 
                            title="Bank Info">
                        <i class="fa fa-university"></i>
                    </button>
        
                    <button class="btn btn-xs ${payslipBtnClass}" 
                            onclick="downloadPayslip(${id})" 
                            ${isPayslipDisabled} 
                            title="${payslipTitle}"
                            style="margin-left: 4px;"> <i class="fa fa-file-pdf-o"></i>
                    </button>
                </div>
           </td>
        </tr>`;
            $tbody.append(tr);
        });
        syncHeaderCheckbox();
    }
    function renderPaginationButtons(totalItems) {
        const totalPages = Math.ceil(totalItems / pageSize);
        const $container = $('#paginationControls').empty();
        if (totalPages <= 1) return;

        let html = `<div class="pagination-compact">`;
        html += `<button class="page-btn" ${pageNumber === 1 ? 'disabled' : ''} onclick="changePage(${pageNumber - 1})">‹</button>`;

        for (let i = 1; i <= totalPages; i++) {
            if (i === 1 || i === totalPages || (i >= pageNumber - 1 && i <= pageNumber + 1)) {
                html += `<button class="page-btn ${i === pageNumber ? 'active' : ''}" onclick="changePage(${i})">${i}</button>`;
            } else if (i === pageNumber - 2 || i === pageNumber + 2) {
                html += `<span class="page-ellipsis">…</span>`;
            }
        }

        html += `<button class="page-btn" ${pageNumber === totalPages ? 'disabled' : ''} onclick="changePage(${pageNumber + 1})">›</button></div>`;
        $container.html(html);
    }

    /* SELECTION LOGIC */
    //$(document).on("change", "#chkAll", function () {
    //    const isChecked = $(this).is(":checked");
    //    $(".row-check").each(function () {
    //        const id = $(this).val();
    //        $(this).prop("checked", isChecked);
    //        if (isChecked) {
    //            if (!selectedPayrollEmployeeIds.includes(id)) selectedPayrollEmployeeIds.push(id);
    //        } else {
    //            selectedPayrollEmployeeIds = selectedPayrollEmployeeIds.filter(item => item !== id);
    //        }
    //    });
    //});
    // 1. Modified Header Checkbox Handler
    $(document).on("change", "#chkAll", function () {
        const isChecked = $(this).is(":checked");
        const totalInGrid = parseInt($("#paginationInfo b").last().text()) || 0; // Get the total count from the "Showing X of TOTAL" text

        if (isChecked && totalInGrid > pageSize) {
            // If there are more records than the current page, ask the user
            if (confirm("Select all " + totalInGrid + " employees across all pages?")) {
                selectAllEmployeesFromServer();
                return;
            }
        }

        // Default behavior: Select only rows on the current page
        $(".row-check").each(function () {
            const id = $(this).val();
            $(this).prop("checked", isChecked);
            if (isChecked) {
                if (!selectedPayrollEmployeeIds.includes(id)) selectedPayrollEmployeeIds.push(id);
            } else {
                selectedPayrollEmployeeIds = selectedPayrollEmployeeIds.filter(item => item !== id);
            }
        });
    });

    // 2. Function to fetch ALL IDs from the server matching current filters
    function selectAllEmployeesFromServer() {
        const month = $("#fltMonth").val();
        const year = $("#fltYear").val();
        const companyId = $("#fltCompany").val() || null;
        const payGroupId = $("#fltPayGroup").val() || null;
        const status = $("#fltStatus").val() || null;
        const search = ($("#searchInput").val() || "").trim();

        showPayrollLoader(); // Show loader as this might take a second

        $.ajax({
            url: "/PayrollSalaryReport/GetAllSelectedIds", // You need to create this simple action
            type: "GET",
            data: {
                month: month, year: year, companyId: companyId,
                payGroupId: payGroupId, search: search, status: status
            },
            success: function (res) {
                if (res.success && res.ids) {
                    // Fill the global memory with ALL IDs
                    selectedPayrollEmployeeIds = res.ids.map(String);

                    // Update UI for current page
                    $(".row-check").prop("checked", true);
                    $("#chkAll").prop("checked", true);

                    toastr.success("All " + selectedPayrollEmployeeIds.length + " employees selected.");
                }
            },
            complete: function () {
                hidePayrollLoader();
            }
        });
    }
    $(document).on("change", ".row-check", function () {
        const id = $(this).val();
        if ($(this).is(":checked")) {
            if (!selectedPayrollEmployeeIds.includes(id)) selectedPayrollEmployeeIds.push(id);
        } else {
            selectedPayrollEmployeeIds = selectedPayrollEmployeeIds.filter(item => item !== id);
        }
        syncHeaderCheckbox();
    });

    function syncHeaderCheckbox() {
        const totalOnPage = $(".row-check").length;
        const selectedOnPage = $(".row-check:checked").length;
        $("#chkAll").prop("checked", totalOnPage > 0 && totalOnPage === selectedOnPage);
    }

    function getSelectedEmployeeIds() { return selectedPayrollEmployeeIds; }

    function resetGlobalSelection() {
        selectedPayrollEmployeeIds = [];
        $("#chkAll").prop("checked", false);
    }

    // UPDATED APPROVE LOGIC TO USE GLOBAL IDS
    function approveSelectedSalaries() {
        const ids = getSelectedEmployeeIds();
        if (!ids.length) { toastr.warning("Please select employees."); return; }
        if (!confirm(`Approve ${ids.length} employees?`)) return;

        showPayrollLoader();
         
        $.ajax({
            url: "/PayrollSalaryReport/BulkApprove",
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify({
                month: parseInt($("#fltMonth").val()),
                year: parseInt($("#fltYear").val()),
                payrollProcessEmployeeIds: ids.join(",")
            }),
            success: function (res) {
                // 1. Handle skipped employees first (Warning Modal)
                if (res.skipped && res.skipped.length > 0) {
                    let skippedHtml = `
                <p class="text-muted mb-md">The following employees were not processed:</p>
                <div class="table-responsive">
                    <table class="table table-bordered table-striped table-condensed mb-none">
                        <thead>
                            <tr style="background:#f8f9fa;">
                                <th style="width:100px;">Code</th>
                                <th>Name</th>
                                <th>Status/Reason</th>
                            </tr>
                        </thead>
                        <tbody>`;

                    res.skipped.forEach(emp => {
                        skippedHtml += `
                    <tr>
                        <td>${emp.Code}</td>
                        <td>${emp.Name}</td>
                        <td><span class="label label-danger" style="display:block; text-align:center;">${emp.Reason}</span></td>
                    </tr>`;
                    });

                    skippedHtml += `</tbody></table></div>`;

                    // Inject into your modal body and show it
                    $("#SkippedEmployeeModal .modal-body").html(skippedHtml);
                    $("#SkippedEmployeeModal").modal('show');
                }

                // 2. Handle overall process success/failure
                if (res.success) {
                    toastr.success(res.message || "Success");
                    refreshGrid();
                    // resetGlobalSelection(); // Highly recommended to clear checkboxes
                } else if (!res.success && (!res.skipped || res.skipped.length === 0)) {
                    // Only show error if no skipped modal was shown to avoid double alerts
                    toastr.error(res.message);
                }
            },
            complete: function () {
                hidePayrollLoader();
            }
        });
    }

    // Helper functions (bindMonthYear, bindSelect, escapeHtml, Loader functions...) remain from your snippet
    function bindMonthYear() {
        const monthList = [{ Value: "1", Text: "January" }, { Value: "2", Text: "February" }, { Value: "3", Text: "March" }, { Value: "4", Text: "April" }, { Value: "5", Text: "May" }, { Value: "6", Text: "June" }, { Value: "7", Text: "July" }, { Value: "8", Text: "August" }, { Value: "9", Text: "September" }, { Value: "10", Text: "October" }, { Value: "11", Text: "November" }, { Value: "12", Text: "December" }];
        const currentYear = new Date().getFullYear();
        const yearList = [];
        for (let y = currentYear; y >= currentYear - 5; y--) { yearList.push({ Value: String(y), Text: String(y) }); }
        const now = new Date();
        const prev = new Date(now.getFullYear(), now.getMonth() - 1, 1);
        bindSelect("#fltMonth", monthList, String(prev.getMonth() + 1));
        bindSelect("#fltYear", yearList, String(prev.getFullYear()));
    }

    function bindSelect(selector, list, selectedValue) {
        const $ddl = $(selector).empty();
        $.each(list, function (i, x) { $ddl.append(`<option value="${x.Value}">${x.Text}</option>`); });
        if (selectedValue) $ddl.val(selectedValue);
    }

    function escapeHtml(text) { return String(text ?? "").replaceAll("&", "&amp;").replaceAll("<", "&lt;").replaceAll(">", "&gt;").replaceAll('"', "&quot;").replaceAll("'", "&#039;"); }

    function toggleFilterPanel() { $("#filterPanel").slideToggle(200); }

    function showPayrollLoader() { $("body").css({ overflow: "hidden", pointerEvents: "none" }); $("#payrollLoader").fadeIn(120).css("pointer-events", "all"); }
    function hidePayrollLoader() { $("#payrollLoader").fadeOut(120, function () { $("body").css({ overflow: "", pointerEvents: "" }); }); }
    /* Clear all filters -> reset dropdowns + search and reload */
    function clearFilters() {

        // reset month/year to current
        const now = new Date();

        const prev = new Date(now.getFullYear(), now.getMonth() - 1, 1);

        const defaultMonth = String(prev.getMonth() + 1);
        const defaultYear = String(prev.getFullYear());

        $("#fltMonth").val(defaultMonth);
        $("#fltYear").val(defaultYear);

        // reset company/paygroup/status
        $("#fltCompany").val("");   // All Companies
        $("#fltPayGroup").val("");  // All Groups
        $("#fltStatus").val("");    // All

        // reset search
        $("#searchInput").val("");

        // reload
        applyFilters();
    }

    // Your button already calls processPayment()
    function processPayment() {
        const ids = getSelectedEmployeeIds();
        if (!ids.length) {
            toastr.warning("Please select at least one employee.");
            return;
        }

        $("#lblSelectedCount").text(ids.length);

        // default date = today
        const d = new Date();
        const yyyy = d.getFullYear();
        const mm = String(d.getMonth() + 1).padStart(2, "0");
        const dd = String(d.getDate()).padStart(2, "0");
        $("#txtPaidDate").val(`${yyyy}-${mm}-${dd}`);

        $("#MarkPaidModal").modal("show");
    }

    $(document).on("click", "#btnConfirmPaid", function () {
        const ids = getSelectedEmployeeIds();
        //alert(ids.length);
        const paidDate = $("#txtPaidDate").val();

        if (!ids.length) {
            toastr.warning("Please select at least one employee.");
            return;
        }
        if (!paidDate) {
            toastr.warning("Please select Paid Date.");
            return;
        }

        showPayrollLoader();
         
        $.ajax({
            url: "/PayrollSalaryReport/MarkPaid",
            type: "POST",
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            data: JSON.stringify({
                month: parseInt($("#fltMonth").val(), 10),
                year: parseInt($("#fltYear").val(), 10),
                paidDate: paidDate,
                payrollProcessEmployeeIds: ids.join(",")
            }),
            success: function (res) {

                if (!res || !res.success) {
                    alert(res?.message || "Failed to mark paid.");
                    return;
                }

                // ✅ Success message
                toastr.success(res.message || "Payment processed");

                // ✅ Optional summary toast
                toastr.info(
                    `Updated: ${res.paidUpdated}, Paid: ${res.paidEmployees}/${res.totalEmployees}`
                );

                // ⚠️ Show skipped employees (if any)
                if (res.skippedEmployees && res.skippedEmployees.length > 0) {
                    showSkippedEmployees(res.skippedEmployees);
                }

                // UI reset
                $("#MarkPaidModal").modal("hide");
                $("#chkAll").prop("checked", false);

                refreshGrid();
            },
            error: function () {
                alert("Server error while marking paid.");
            },
            complete: function () {
                hidePayrollLoader();
            }
        });

    });

    function showSkippedEmployees(list) {

        let html = `
    <table class="table table-sm table-bordered">
        <thead>
            <tr>
                <th>Employee</th>
                <th>Reason</th>
            </tr>
        </thead>
        <tbody>
`;

        list.forEach(e => {
            html += `
        <tr>
            <td>${e.EmployeeName}</td>
            <td>${e.SkipReason}</td>
        </tr>`;
        });

        html += `</tbody></table>`;

        $("#SkippedEmployeeModal .modal-body").html(html);
        $("#SkippedEmployeeModal").modal("show");
    }
    /* =====================================================
       REJECT SELECTED SALARIES (SEND BACK TO KITCHEN)
       ===================================================== */
    function rejectSelectedSalaries() {
        // 1. Get IDs from our global "Memory" array
        const ids = getSelectedEmployeeIds();

        if (!ids.length) {
            toastr.warning("Please select at least one employee to reject.");
            return;
        }

        // 2. Ask for a Reason (Important for Audit Trail)
        const reason = prompt("Enter reason for rejection (this will unlock the records for editing):");

        if (reason === null) return; // User clicked cancel
        if (reason.trim() === "") {
            toastr.error("Rejection reason is required.");
            return;
        }

        // 3. Confirmation
        if (!confirm(`Are you sure you want to REJECT and UNLOCK ${ids.length} employees? This will reverse any loan deductions linked to this payroll.`)) {
            return;
        }

        showPayrollLoader();
         
        $.ajax({
            url: "/PayrollSalaryReport/BulkReject",
            type: "POST",
            contentType: "application/json; charset=utf-8",
            data: JSON.stringify({
                payrollProcessEmployeeIds: ids.join(","),
                reason: reason,
                month: parseInt($("#fltMonth").val(), 10),
                year: parseInt($("#fltYear").val(), 10)
            }),
            success: function (res) {
                // 1. Handle Skipped Employees (Finalized or Already Rejected)
                if (res.skipped && res.skipped.length > 0) {
                    let skippedHtml = `
                <p class="text-muted mb-md">The following records were not processed:</p>
                <div class="table-responsive">
                    <table class="table table-bordered table-striped table-condensed mb-none">
                        <thead>
                            <tr style="background:#f8f9fa;">
                                <th>Code</th>
                                <th>Name</th>
                                <th>Reason</th>
                            </tr>
                        </thead>
                        <tbody>`;

                    res.skipped.forEach(emp => {
                        skippedHtml += `
                    <tr>
                        <td>${emp.Code}</td>
                        <td>${emp.Name}</td>
                        <td><span class="label label-warning" style="display:block; text-align:center;">${emp.Reason}</span></td>
                    </tr>`;
                    });

                    skippedHtml += `</tbody></table></div>`;

                    // Inject into your existing modal and show it
                    $("#SkippedEmployeeModal .modal-body").html(skippedHtml);
                    $("#SkippedEmployeeModal").modal('show');
                }

                // 2. Handle Success
                if (res.success) {
                    toastr.info(res.message || "Salaries rejected. Records are now unlocked for modification.");

                    // Clear selection so old IDs don't haunt the next action
                    if (typeof resetGlobalSelection === "function") {
                        resetGlobalSelection();
                    }

                    refreshGrid();

                    // Close the "Reason Input" modal if you have one
                    $("#modalRejectReason").modal('hide');
                }
                // 3. Handle Error (only if no skipped items were shown, to prevent double alerts)
                else if (!res.success && (!res.skipped || res.skipped.length === 0)) {
                    toastr.error(res.message || "Rejection failed.");
                }
            },
            error: function () {
                toastr.error("Server error during rejection process.");
            },
            complete: function () {
                hidePayrollLoader();
            }
        });
    }
    function exportExcel() {
        const ids = getSelectedEmployeeIds();
        if (!ids.length) { toastr.warning("Please select employees."); return; }
         
        const month = parseInt($("#fltMonth").val() || "0", 10);
        const year = parseInt($("#fltYear").val() || "0", 10);
 

        if (!month || !year) {
            alert("Please select Month and Year");
            return;
        }

        // 🔹 Build query string
        const qs = $.param({
            month: month,
            year: year, 
            payrollProcessEmployeeIds: ids.join(",")
        });

        // 🔹 Trigger download (AJAX is NOT suitable for file streams)
        window.location.href = `/PayrollSalaryReport/ExportExcel?${qs}`;
    }
    function openBankModal(empId, name) {

        // Set name immediately (good UX)
        $('#lblModalName').text(name);

        // Show loading placeholders
        $('#lblModalBank').text('Loading...');
        $('#lblModalBranch').text('Loading...');
        $('#lblModalIfsc').text('Loading...');
        $('#lblModalAcct').text('Loading...');

        $('#BankModal').modal('show');

        $.ajax({
            url: '/PayrollSalaryReport/GetEmployeeBank',
            type: 'GET',
            dataType: 'json',
            data: { employeeId: empId },
            success: function (res) {

                if (!res || !res.success) {
                    $('#lblModalBank').text('—');
                    $('#lblModalBranch').text('—');
                    $('#lblModalIfsc').text('—');
                    $('#lblModalAcct').text('—');
                    toastr.warning(res?.message || 'Bank details not found');
                    return;
                }

                $('#lblModalBank').text(res.bankName || '—');
                $('#lblModalBranch').text(res.branch || '—');
                $('#lblModalIfsc').text(res.ifsc || '—');
                $('#lblModalAcct').text(res.accountNo || '—');
            },
            error: function () {
                $('#lblModalBank').text('—');
                $('#lblModalBranch').text('—');
                $('#lblModalIfsc').text('—');
                $('#lblModalAcct').text('—');
                toastr.error('Server error while loading bank details');
            }
        });
    }
</script>*@
<script>
    let pageNumber = 1;
    let pageSize = 50;
    let selectedPayrollEmployeeIds = []; // 🔑 GLOBAL MEMORY

    $(document).ready(function () {
        $("#fltStatus").val("");
        pageSize = parseInt($("#ddlPageSize").val() || "50");
        loadFilterData();
    });

    $(document).on("change", "#fltMonth,#fltYear,#fltCompany,#fltPayGroup,#fltStatus", function () {
        applyFilters();
    });

    function applyFilters() {
        pageNumber = 1;
        // 🔑 Clear memory ONLY when filters change
        resetGlobalSelection();
        refreshGrid();
    }

    function refreshGrid() {
        const month = parseInt($("#fltMonth").val() || "0", 10);
        const year = parseInt($("#fltYear").val() || "0", 10);

        // ❌ FIXED: DO NOT call resetGlobalSelection here, otherwise next page clears Page 1 selection
        $("#chkAll").prop("checked", false);

        if (!month || !year) {
            $("#gridBody").html('<tr><td colspan="11" class="text-center p-lg text-muted">Select Month and Year.</td></tr>');
            return;
        }

        $("#gridBody").html('<tr><td colspan="11" class="text-center p-lg text-muted"><i class="fa fa-spinner fa-spin"></i> Loading...</td></tr>');

        $.ajax({
            url: "/PayrollSalaryReport/GetGrid",
            type: "GET",
            data: {
                month: month, year: year,
                companyId: $("#fltCompany").val() || null,
                payGroupId: $("#fltPayGroup").val() || null,
                search: ($("#searchInput").val() || "").trim(),
                status: $("#fltStatus").val() || null,
                pageNumber: pageNumber, pageSize: pageSize
            },
            success: function (res) {
                if (!res || !res.success || !res.rows.length) {
                    $("#gridBody").html('<tr><td colspan="11" class="text-center p-lg text-muted">No records found.</td></tr>');
                    $("#paginationInfo").text("");
                    $("#paginationControls").empty();
                    return;
                }

                renderSalaryRegisterGrid(res.rows);

                const total = Number(res.totalRows || 0);
                const from = ((pageNumber - 1) * pageSize + 1);
                const to = Math.min(pageNumber * pageSize, total);
                $("#paginationInfo").html(`Showing <b>${from}</b> to <b>${to}</b> of <b>${total}</b> entries`);
                renderPaginationButtons(total);
            }
        });
    }

    function renderSalaryRegisterGrid(rows) {
        const $tbody = $("#gridBody").empty();
        rows.forEach(function (r) {
            const id = String(r.PayrollProcessEmployeeID);
            // 🔑 Restore checkbox state from memory
            const isChecked = selectedPayrollEmployeeIds.includes(id) ? "checked" : "";

            let statusBadge = r.Status == 2 ? '<span class="label label-success">Finalized</span>' :
                (r.Status == 3 ? '<span class="label label-danger">Rejected</span>' : '<span class="label label-warning">Draft</span>');

            const tr = `
            <tr>
                <td><input type="checkbox" class="row-check" value="${id}" ${isChecked}></td>
                <td><b>${escapeHtml(r.EmployeeName)}</b><br/><small>${escapeHtml(r.EmployeeCode)}</small></td>
                <td>${escapeHtml(r.CompanyName)}</td>
                <td class="text-right">${Number(r.BasicAmount || 0).toLocaleString('en-IN')}</td>
                <td class="text-right">${Number(r.AllowancesAmount || 0).toLocaleString('en-IN')}</td>
                <td class="text-right"><b>${Number(r.TotalGross || 0).toLocaleString('en-IN')}</b></td>
                <td class="text-right text-danger">${Number(r.TotalDeduction || 0).toLocaleString('en-IN')}</td>
                <td class="text-right text-primary"><b>${Number(r.TotalTakeHome || 0).toLocaleString('en-IN')}</b></td>
                <td class="text-center">${statusBadge}</td>
                <td class="text-center">${r.PaidStatus == 1 ? 'Paid' : 'Pending'}</td>
                <td class="text-center">
                    <button class="btn btn-xs btn-default" onclick="openBankModal(${r.EmployeeID}, '${escapeHtml(r.EmployeeName)}')"><i class="fa fa-university"></i></button>
                    <button class="btn btn-xs btn-primary" onclick="downloadPayslip(${id})" ${r.Status == 2 ? '' : 'disabled'}><i class="fa fa-file-pdf-o"></i></button>
                </td>
            </tr>`;
            $tbody.append(tr);
        });
        syncHeaderCheckbox();
    }
    /* --- 🔑 CLEAN SELECTION LOGIC --- */
    $(document).on("change", "#chkAll", function () {
        const isChecked = $(this).is(":checked");

        if (isChecked) {
            // 1. Visual Feedback: Check all visible rows immediately for better UX
            $(".row-check").prop("checked", true);

            // 2. Fetch all IDs from server for global selection (across all pages)
            selectAllEmployeesFromServer();
        } else {
            // 1. Immediately clear the entire memory array
            selectedPayrollEmployeeIds = [];

            // 2. Uncheck all visible boxes
            $(".row-check").prop("checked", false);

            toastr.info("All selections cleared.");
        }
    });

    /* --- 🛡️ Individual Row Handler --- */
    $(document).on("change", ".row-check", function () {
        const id = $(this).val();
        const isChecked = $(this).is(":checked");

        if (isChecked) {
            if (!selectedPayrollEmployeeIds.includes(id)) {
                selectedPayrollEmployeeIds.push(id);
            }
        } else {
            // Remove specific ID from memory
            selectedPayrollEmployeeIds = selectedPayrollEmployeeIds.filter(item => item !== id);
        }

        // Sync the master checkbox (uncheck master if one row is unchecked)
        syncHeaderCheckbox();
    });

    /* --- 📡 Server Fetch for IDs (Bug-Safe version) --- */
    function selectAllEmployeesFromServer() {
        showPayrollLoader();

        $.ajax({
            url: "/PayrollSalaryReport/GetAllSelectedIds",
            type: "GET",
            data: {
                month: $("#fltMonth").val(),
                year: $("#fltYear").val(),
                companyId: $("#fltCompany").val() || null,
                payGroupId: $("#fltPayGroup").val() || null,
                status: $("#fltStatus").val() || null,
                search: ($("#searchInput").val() || "").trim()
            },
            success: function (res) {
                // 🛡️ CRITICAL CHECK: Only apply results if the user hasn't 
                // unchecked the "Select All" box while the request was loading.
                if ($("#chkAll").is(":checked")) {
                    if (res.success && res.ids) {
                        selectedPayrollEmployeeIds = res.ids.map(String);
                        toastr.success(`All ${selectedPayrollEmployeeIds.length} employees selected.`);
                    }
                }
            },
            complete: function () {
                hidePayrollLoader();
            }
        });
    }

    /* --- 🛡️ Re-Sync Header State --- */
    function syncHeaderCheckbox() {
        const rowsOnPage = $(".row-check");
        if (rowsOnPage.length === 0) return;

        let allOnPageSelected = true;
        rowsOnPage.each(function () {
            if (!selectedPayrollEmployeeIds.includes($(this).val())) {
                allOnPageSelected = false;
                return false; // break loop
            }
        });

        $("#chkAll").prop("checked", allOnPageSelected);
    }
    function resetGlobalSelection() {
        selectedPayrollEmployeeIds = [];
        $("#chkAll").prop("checked", false);
    }

    function getSelectedEmployeeIds() { return selectedPayrollEmployeeIds; }

    function rejectSelectedSalaries() {
        // 1. Get IDs from our global "Memory" array
        const ids = getSelectedEmployeeIds();

        if (!ids.length) {
            toastr.warning("Please select at least one employee to reject.");
            return;
        }

        // 2. Ask for a Reason (Important for Audit Trail)
        const reason = prompt("Enter reason for rejection (this will unlock the records for editing):");

        if (reason === null) return; // User clicked cancel
        if (reason.trim() === "") {
            toastr.error("Rejection reason is required.");
            return;
        }

        // 3. Confirmation
        if (!confirm(`Are you sure you want to REJECT and UNLOCK ${ids.length} employees? This will reverse any loan deductions linked to this payroll.`)) {
            return;
        }

        showPayrollLoader();

        $.ajax({
            url: "/PayrollSalaryReport/BulkReject",
            type: "POST",
            contentType: "application/json; charset=utf-8",
            data: JSON.stringify({
                payrollProcessEmployeeIds: ids.join(","),
                reason: reason,
                month: parseInt($("#fltMonth").val(), 10),
                year: parseInt($("#fltYear").val(), 10)
            }),
            success: function (res) {
                // 1. Handle Skipped Employees (Finalized or Already Rejected)
                if (res.skipped && res.skipped.length > 0) {
                    let skippedHtml = `
              <p class="text-muted mb-md">The following records were not processed:</p>
              <div class="table-responsive">
                  <table class="table table-bordered table-striped table-condensed mb-none">
                      <thead>
                          <tr style="background:#f8f9fa;">
                              <th>Code</th>
                              <th>Name</th>
                              <th>Reason</th>
                          </tr>
                      </thead>
                      <tbody>`;

                    res.skipped.forEach(emp => {
                        skippedHtml += `
                  <tr>
                      <td>${emp.Code}</td>
                      <td>${emp.Name}</td>
                      <td><span class="label label-warning" style="display:block; text-align:center;">${emp.Reason}</span></td>
                  </tr>`;
                    });

                    skippedHtml += `</tbody></table></div>`;

                    // Inject into your existing modal and show it
                    $("#SkippedEmployeeModal .modal-body").html(skippedHtml);
                    $("#SkippedEmployeeModal").modal('show');
                }

                // 2. Handle Success
                if (res.success) {
                    toastr.info(res.message || "Salaries rejected. Records are now unlocked for modification.");

                    // Clear selection so old IDs don't haunt the next action
                    if (typeof resetGlobalSelection === "function") {
                        resetGlobalSelection();
                    }

                    refreshGrid();

                    // Close the "Reason Input" modal if you have one
                    $("#modalRejectReason").modal('hide');
                }
                // 3. Handle Error (only if no skipped items were shown, to prevent double alerts)
                else if (!res.success && (!res.skipped || res.skipped.length === 0)) {
                    toastr.error(res.message || "Rejection failed.");
                }
            },
            error: function () {
                toastr.error("Server error during rejection process.");
            },
            complete: function () {
                hidePayrollLoader();
            }
        });
    }
    function exportExcel() {
        const ids = getSelectedEmployeeIds();
        if (!ids.length) { toastr.warning("Please select employees."); return; }

        const month = parseInt($("#fltMonth").val() || "0", 10);
        const year = parseInt($("#fltYear").val() || "0", 10);


        if (!month || !year) {
            toastr.warning("Please select Month and Year");
            return;
        }

        // 🔹 Build query string
        const qs = $.param({
            month: month,
            year: year,
            payrollProcessEmployeeIds: ids.join(",")
        });

        // 🔹 Trigger download (AJAX is NOT suitable for file streams)
        window.location.href = `/PayrollSalaryReport/ExportExcel?${qs}`;
    }
    function openBankModal(empId, name) {

        // Set name immediately (good UX)
        $('#lblModalName').text(name);

        // Show loading placeholders
        $('#lblModalBank').text('Loading...');
        $('#lblModalBranch').text('Loading...');
        $('#lblModalIfsc').text('Loading...');
        $('#lblModalAcct').text('Loading...');

        $('#BankModal').modal('show');

        $.ajax({
            url: '/PayrollSalaryReport/GetEmployeeBank',
            type: 'GET',
            dataType: 'json',
            data: { employeeId: empId },
            success: function (res) {

                if (!res || !res.success) {
                    $('#lblModalBank').text('—');
                    $('#lblModalBranch').text('—');
                    $('#lblModalIfsc').text('—');
                    $('#lblModalAcct').text('—');
                    toastr.warning(res?.message || 'Bank details not found');
                    return;
                }

                $('#lblModalBank').text(res.bankName || '—');
                $('#lblModalBranch').text(res.branch || '—');
                $('#lblModalIfsc').text(res.ifsc || '—');
                $('#lblModalAcct').text(res.accountNo || '—');
            },
            error: function () {
                $('#lblModalBank').text('—');
                $('#lblModalBranch').text('—');
                $('#lblModalIfsc').text('—');
                $('#lblModalAcct').text('—');
                toastr.error('Server error while loading bank details');
            }
        });
    }

    // UPDATED APPROVE LOGIC TO USE GLOBAL IDS
    function approveSelectedSalaries() {
        const ids = getSelectedEmployeeIds();
        if (!ids.length) { toastr.warning("Please select employees."); return; }
        if (!confirm(`Approve ${ids.length} employees?`)) return;

        showPayrollLoader();

        $.ajax({
            url: "/PayrollSalaryReport/BulkApprove",
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify({
                month: parseInt($("#fltMonth").val()),
                year: parseInt($("#fltYear").val()),
                payrollProcessEmployeeIds: ids.join(",")
            }),
            success: function (res) {
                // 1. Handle skipped employees first (Warning Modal)
                if (res.skipped && res.skipped.length > 0) {
                    let skippedHtml = `
            <p class="text-muted mb-md">The following employees were not processed:</p>
            <div class="table-responsive">
                <table class="table table-bordered table-striped table-condensed mb-none">
                    <thead>
                        <tr style="background:#f8f9fa;">
                            <th style="width:100px;">Code</th>
                            <th>Name</th>
                            <th>Status/Reason</th>
                        </tr>
                    </thead>
                    <tbody>`;

                    res.skipped.forEach(emp => {
                        skippedHtml += `
                <tr>
                    <td>${emp.Code}</td>
                    <td>${emp.Name}</td>
                    <td><span class="label label-danger" style="display:block; text-align:center;">${emp.Reason}</span></td>
                </tr>`;
                    });

                    skippedHtml += `</tbody></table></div>`;

                    // Inject into your modal body and show it
                    $("#SkippedEmployeeModal .modal-body").html(skippedHtml);
                    $("#SkippedEmployeeModal").modal('show');
                }

                // 2. Handle overall process success/failure
                if (res.success) {
                    toastr.success(res.message || "Success");
                    refreshGrid();
                    // resetGlobalSelection(); // Highly recommended to clear checkboxes
                } else if (!res.success && (!res.skipped || res.skipped.length === 0)) {
                    // Only show error if no skipped modal was shown to avoid double alerts
                    toastr.error(res.message);
                }
            },
            complete: function () {
                hidePayrollLoader();
            }
        });
    }
    function loadFilterData() {
        bindMonthYear(); // Sync call
        $.ajax({
            url: "/PayrollSalaryReport/GetFilterData",
            type: "GET",
            success: function (res) {
                if (res && res.success) {
                    const companies = [{ Value: "", Text: "All Companies" }].concat(res.companies || []);
                    bindSelect("#fltCompany", companies, "");
                    const payGroups = [{ Value: "", Text: "All Groups" }].concat(res.payGroups || []);
                    bindSelect("#fltPayGroup", payGroups, "");
                }
                refreshGrid(); // Trigger first hit here
            },
            error: function () { refreshGrid(); }
        });
    }
    function bindMonthYear() {
        const monthList = [{ Value: "1", Text: "January" }, { Value: "2", Text: "February" }, { Value: "3", Text: "March" }, { Value: "4", Text: "April" }, { Value: "5", Text: "May" }, { Value: "6", Text: "June" }, { Value: "7", Text: "July" }, { Value: "8", Text: "August" }, { Value: "9", Text: "September" }, { Value: "10", Text: "October" }, { Value: "11", Text: "November" }, { Value: "12", Text: "December" }];
        const currentYear = new Date().getFullYear();
        const yearList = [];
        for (let y = currentYear; y >= currentYear - 5; y--) { yearList.push({ Value: String(y), Text: String(y) }); }
        const now = new Date();
        const prev = new Date(now.getFullYear(), now.getMonth() - 1, 1);
        bindSelect("#fltMonth", monthList, String(prev.getMonth() + 1));
        bindSelect("#fltYear", yearList, String(prev.getFullYear()));
    }
    function bindSelect(selector, list, selectedValue) {
        const $ddl = $(selector).empty();
        $.each(list, function (i, x) { $ddl.append(`<option value="${x.Value}">${x.Text}</option>`); });
        if (selectedValue) $ddl.val(selectedValue);
    }

    function escapeHtml(text) { return String(text ?? "").replaceAll("&", "&amp;").replaceAll("<", "&lt;").replaceAll(">", "&gt;").replaceAll('"', "&quot;").replaceAll("'", "&#039;"); }

    function toggleFilterPanel() { $("#filterPanel").slideToggle(200); }

    function showPayrollLoader() { $("body").css({ overflow: "hidden", pointerEvents: "none" }); $("#payrollLoader").fadeIn(120).css("pointer-events", "all"); }
    function hidePayrollLoader() { $("#payrollLoader").fadeOut(120, function () { $("body").css({ overflow: "", pointerEvents: "" }); }); }
    function renderPaginationButtons(totalItems) {
        const totalPages = Math.ceil(totalItems / pageSize);
        const $container = $('#paginationControls').empty();
        if (totalPages <= 1) return;

        let html = `<div class="pagination-compact">`;
        html += `<button class="page-btn" ${pageNumber === 1 ? 'disabled' : ''} onclick="changePage(${pageNumber - 1})">‹</button>`;

        for (let i = 1; i <= totalPages; i++) {
            if (i === 1 || i === totalPages || (i >= pageNumber - 1 && i <= pageNumber + 1)) {
                html += `<button class="page-btn ${i === pageNumber ? 'active' : ''}" onclick="changePage(${i})">${i}</button>`;
            } else if (i === pageNumber - 2 || i === pageNumber + 2) {
                html += `<span class="page-ellipsis">…</span>`;
            }
        }

        html += `<button class="page-btn" ${pageNumber === totalPages ? 'disabled' : ''} onclick="changePage(${pageNumber + 1})">›</button></div>`;
        $container.html(html);
    }
    function changePageSize() {
        pageSize = parseInt($("#ddlPageSize").val());
        pageNumber = 1;
        refreshGrid();
    } 

    function changePage(p) {
        pageNumber = p;
        refreshGrid();
    } 
    function processPayment() {
        const ids = getSelectedEmployeeIds();
        if (!ids.length) {
            toastr.warning("Please select at least one employee.");
            return;
        }

        $("#lblSelectedCount").text(ids.length);

        // Set default date to today
        const d = new Date();
        const yyyy = d.getFullYear();
        const mm = String(d.getMonth() + 1).padStart(2, "0");
        const dd = String(d.getDate()).padStart(2, "0");
        $("#txtPaidDate").val(`${yyyy}-${mm}-${dd}`);

        $("#MarkPaidModal").modal("show");
    }

    $(document).on("click", "#btnConfirmPaid", function () {
        const ids = getSelectedEmployeeIds();
        const paidDate = $("#txtPaidDate").val();

        if (!ids.length) {
            toastr.warning("Please select at least one employee.");
            return;
        }
        if (!paidDate) {
            toastr.warning("Please select Paid Date.");
            return;
        }

        showPayrollLoader();

        $.ajax({
            url: "/PayrollSalaryReport/MarkPaid",
            type: "POST",
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            data: JSON.stringify({
                month: parseInt($("#fltMonth").val(), 10),
                year: parseInt($("#fltYear").val(), 10),
                paidDate: paidDate,
                payrollProcessEmployeeIds: ids.join(",")
            }),
            success: function (res) {
                if (!res || !res.success) {
                    // Check if the server sent back skipped employees even on a "failure" (e.g., none were finalized)
                    if (res.skippedEmployees && res.skippedEmployees.length > 0) {
                        showSkippedEmployees(res.skippedEmployees);
                    }
                    toastr.error(res?.message || "Failed to mark paid.");
                    return;
                }

                // ✅ 1. Success Message
                toastr.success(res.message || "Payment processed successfully.");

                // ✅ 2. Optional summary info
                toastr.info(`Updated: ${res.paidUpdated}, Paid: ${res.paidEmployees}/${res.totalEmployees}`);

                // ⚠️ 3. Show skipped employees (Draft or Rejected records that were selected)
                if (res.skippedEmployees && res.skippedEmployees.length > 0) {
                    showSkippedEmployees(res.skippedEmployees);
                }

                // ✅ 4. CRITICAL: Clear global memory after successful payment
                if (typeof resetGlobalSelection === "function") {
                    resetGlobalSelection();
                }

                // 5. UI reset & Refresh
                $("#MarkPaidModal").modal("hide");
                refreshGrid();
            },
            error: function () {
                toastr.error("Server error while marking paid.");
            },
            complete: function () {
                hidePayrollLoader();
            }
        });
    });

    function showSkippedEmployees(list) {
        let html = `
        <p class="text-semibold">The following employees were skipped (Only 'Finalized' records can be marked paid):</p>
        <table class="table table-sm table-bordered mt-md">
            <thead>
                <tr class="bg-light">
                    <th>Employee Name</th>
                    <th>Reason</th>
                </tr>
            </thead>
            <tbody>`;

        list.forEach(e => {
            html += `
            <tr>
                <td>${escapeHtml(e.EmployeeName)}</td>
                <td><span class="text-danger">${escapeHtml(e.SkipReason)}</span></td>
            </tr>`;
        });

        html += `</tbody></table>`;

        $("#SkippedEmployeeModal .modal-body").html(html);
        $("#SkippedEmployeeModal").modal("show");
    }
</script>